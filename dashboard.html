<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro â€” Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
</head>
<body>

<div class="topbar">
  <div class="topbar-brand">TestPro</div>
  <div style="display:flex;gap:0.6rem;align-items:center">
    <button class="theme-toggle">ğŸŒ™</button>
    <button class="hamburger sidebar-toggle"><span></span><span></span><span></span></button>
  </div>
</div>
<div class="sidebar-overlay"></div>

<aside class="sidebar">
  <div style="padding:1.25rem 1rem 0.5rem;border-bottom:1px solid var(--border)">
    <div style="font-family:'Unbounded',sans-serif;font-size:1.2rem;font-weight:900;background:var(--grad-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">TestPro</div>
  </div>
  <div class="sidebar-inner">
    <div class="sidebar-section-label">Asosiy</div>
    <a href="dashboard.html" class="sidebar-nav-item active">ğŸ“Š Dashboard</a>
    <a href="create.html" class="sidebar-nav-item">âœï¸ Test yaratish</a>

    <div class="sidebar-section-label" style="margin-top:0.5rem">Mening</div>
    <a href="#" class="sidebar-nav-item" onclick="showTab('my-tests');return false">ğŸ“ Testlarim</a>
    <a href="history.html" class="sidebar-nav-item">ğŸ“œ Tarix</a>

    <div class="sidebar-section-label" style="margin-top:0.5rem">Kirish</div>
    <a href="#" class="sidebar-nav-item" onclick="Modal.open('code-modal');return false">ğŸ”‘ Kod orqali kirish</a>
    <a href="index.html" class="sidebar-nav-item">ğŸŒ Testlar</a>
  </div>
  <div class="sidebar-footer">
    <div class="user-chip">
      <div class="user-ava" id="ava">?</div>
      <div style="flex:1;min-width:0">
        <div class="user-chip-name" id="uname">...</div>
        <div class="user-chip-role" id="urole">foydalanuvchi</div>
      </div>
      <a href="profile.html" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem" data-tip="Profil">ğŸ‘¤</a>
      <button id="logout-btn" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem" data-tip="Chiqish">ğŸšª</button>
    </div>
  </div>
</aside>

<main class="main-area">
  <div class="page-hdr" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem">
    <div>
      <h1>Dashboard</h1>
      <p>Faoliyatingiz statistikasi</p>
    </div>
    <a href="create.html" class="btn btn-primary">+ Yangi test</a>
  </div>

  <!-- Stats -->
  <div class="grid-4" style="margin-bottom:1.75rem">
    <div class="stat-card fade-in">
      <div class="stat-icon" style="background:rgba(79,70,229,0.1)">ğŸ“</div>
      <div class="stat-val" id="s-tests">0</div>
      <div class="stat-lbl">Testlarim</div>
    </div>
    <div class="stat-card fade-in d1">
      <div class="stat-icon" style="background:rgba(16,185,129,0.1)">âœ…</div>
      <div class="stat-val" id="s-done">0</div>
      <div class="stat-lbl">Ishlangan</div>
    </div>
    <div class="stat-card fade-in d2">
      <div class="stat-icon" style="background:rgba(245,158,11,0.1)">â­</div>
      <div class="stat-val" id="s-avg">â€”</div>
      <div class="stat-lbl">O'rtacha ball</div>
    </div>
    <div class="stat-card fade-in d3">
      <div class="stat-icon" style="background:rgba(6,182,212,0.1)">ğŸ”¥</div>
      <div class="stat-val" id="s-streak">0</div>
      <div class="stat-lbl">Kun ketma-ket</div>
    </div>
  </div>

  <!-- Tabs -->
  <div style="display:flex;gap:0.35rem;background:var(--bg-2);padding:3px;border-radius:var(--radius-sm);width:fit-content;margin-bottom:1.5rem">
    <button class="auth-tab active" id="tab-my" onclick="showTab('my-tests')" style="padding:0.5rem 1.1rem;font-size:0.82rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:all var(--t);font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-3)">ğŸ“ Testlarim</button>
    <button class="auth-tab" id="tab-pub" onclick="showTab('public')" style="padding:0.5rem 1.1rem;font-size:0.82rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:all var(--t);font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-3)">ğŸŒ Ommaviy</button>
    <button class="auth-tab" id="tab-coded" onclick="showTab('coded')" style="padding:0.5rem 1.1rem;font-size:0.82rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:all var(--t);font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-3)">ğŸ”‘ Kodli</button>
  </div>
  <style>.auth-tab.active{background:var(--bg-card);color:var(--accent);box-shadow:var(--shadow-sm)} [data-theme="dark"] .auth-tab.active{background:var(--bg)}</style>

  <!-- My tests -->
  <div id="tab-my-tests">
    <div id="my-tests-list">
      <div class="empty"><div class="empty-icon">ğŸ“­</div><h3>Test yo'q</h3><p><a href="create.html" class="btn btn-primary btn-sm" style="margin-top:0.75rem;display:inline-flex">Test yaratish</a></p></div>
    </div>
  </div>

  <!-- Public tests by subject (carousel) -->
  <div id="tab-public" style="display:none">
    <div id="pub-loading" style="text-align:center;padding:2rem"><div class="spinner" style="margin:0 auto"></div></div>
    <div id="pub-container"></div>
  </div>

  <!-- Coded tests (unlocked) -->
  <div id="tab-coded" style="display:none">
    <div class="glass-card" style="text-align:center;padding:2.5rem 1.5rem">
      <div style="font-size:2rem;margin-bottom:0.75rem">ğŸ”‘</div>
      <h3 style="font-size:1rem;margin-bottom:0.5rem">Kod orqali kirish</h3>
      <p style="font-size:0.85rem;color:var(--text-2);margin-bottom:1.25rem">Do'stingiz bergan 6 xonali kodni kiriting</p>
      <button class="btn btn-primary" onclick="Modal.open('code-modal')">Kod kiritish</button>
    </div>
    <div id="unlocked-list" style="margin-top:1.25rem"></div>
  </div>

</main>

<!-- Code modal -->
<div class="modal-overlay" id="code-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title">ğŸ”‘ Test kodi</span>
      <button class="modal-close">âœ•</button>
    </div>
    <p style="font-size:0.85rem;color:var(--text-2);margin-bottom:1rem">6 xonali kodni kiriting:</p>
    <div class="code-input" id="code-inputs">
      <input maxlength="1"/><input maxlength="1"/><input maxlength="1"/>
      <input maxlength="1"/><input maxlength="1"/><input maxlength="1"/>
    </div>
    <div id="code-result" style="margin-bottom:1rem"></div>
    <div style="display:flex;gap:0.75rem;justify-content:flex-end">
      <button class="btn btn-ghost" data-close-modal>Bekor</button>
      <button class="btn btn-primary" id="enter-code-btn">Qidirish â†’</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
let currentUser = null;

(async () => {
  currentUser = await AuthHelpers.requireAuth('login.html');
  if (!currentUser) return;

  const profile = await DB.getUser(currentUser.uid).catch(() => null);
  const name = profile?.name || currentUser.displayName || 'Foydalanuvchi';
  document.getElementById('ava').textContent = name[0].toUpperCase();
  document.getElementById('uname').textContent = name;
  document.getElementById('urole').textContent = profile?.role === 'admin' ? 'ğŸ‘‘ Admin' : 'Foydalanuvchi';

  if (profile?.role === 'admin') {
    const nav = document.querySelector('.sidebar-inner');
    nav.insertAdjacentHTML('afterbegin', '<a href="admin.html" class="sidebar-nav-item" style="color:#D97706;margin-bottom:0.25rem">ğŸ‘‘ Admin panel</a>');
  }

  // Load data
  const [myTests, results] = await Promise.all([
    DB.getTests({ authorId: currentUser.uid }).catch(() => []),
    DB.getResults({ userId: currentUser.uid, limit: 50 }).catch(() => []),
  ]);

  // Stats
  document.getElementById('s-tests').textContent = myTests.length;
  document.getElementById('s-done').textContent  = results.length;
  if (results.length) {
    const avg = Math.round(results.reduce((s,r) => s+(r.score||0), 0) / results.length);
    document.getElementById('s-avg').textContent = avg + '%';
  }

  renderMyTests(myTests);

  // Coded (from localStorage)
  const unlocked = JSON.parse(localStorage.getItem('tp_unlocked') || '[]');
  if (unlocked.length) {
    const items = await Promise.all(unlocked.map(id => DB.getTest(id).catch(() => null)));
    const valid = items.filter(Boolean);
    if (valid.length) {
      document.getElementById('unlocked-list').innerHTML = `<h3 style="font-size:0.9rem;margin-bottom:0.85rem;color:var(--text-2)">Ochilgan testlar</h3>` +
        valid.map(t => testRow(t)).join('');
    }
  }
})();

function renderMyTests(tests) {
  const wrap = document.getElementById('my-tests-list');
  if (!tests.length) return;
  wrap.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.75rem">` +
    tests.map(t => {
      const sub = getSubject(t.subject);
      const vis = t.visibility === 'public' ? `<span class="badge badge-green">ğŸŒ Public</span>` :
                  t.visibility === 'code'   ? `<span class="badge badge-amber">ğŸ”’ Kodli</span>` :
                                              `<span class="badge badge-gray">ğŸ”’ Shaxsiy</span>`;
      const share = t.visibility === 'code' && t.accessCode
        ? `<button class="btn btn-teal btn-sm" onclick="copyCode('${t.accessCode}')">ğŸ“‹ ${t.accessCode}</button>` : '';
      return `
        <div class="history-item">
          <div class="history-info">
            <div class="history-title">${esc(t.title)}</div>
            <div class="history-meta">
              <span class="subj-badge ${sub.cls}">${sub.emoji} ${esc(sub.label)}</span>
              ğŸ“ ${t.questionCount||0} savol Â· ğŸ‘ï¸ ${t.attempts||0} Â· ${fmtDate(t.createdAt)}
              ${vis}
            </div>
          </div>
          <div style="display:flex;gap:0.5rem;flex-shrink:0;flex-wrap:wrap">
            ${share}
            <a href="test.html?id=${t.id}" class="btn btn-secondary btn-sm">â–¶ï¸</a>
            <a href="create.html?id=${t.id}" class="btn btn-ghost btn-sm">âœï¸</a>
            <button class="btn btn-danger btn-sm" onclick="delTest('${t.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>`;
    }).join('') + `</div>`;
}

function testRow(t) {
  const sub = getSubject(t.subject);
  return `<div class="history-item" style="margin-bottom:0.75rem">
    <div class="history-info">
      <div class="history-title">${esc(t.title)}</div>
      <div class="history-meta"><span class="subj-badge ${sub.cls}">${sub.emoji} ${esc(sub.label)}</span></div>
    </div>
    <a href="test.html?id=${t.id}" class="btn btn-primary btn-sm">Boshlash â†’</a>
  </div>`;
}

function showTab(tab) {
  ['my-tests','public','coded'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  ['tab-my','tab-pub','tab-coded-btn'].forEach(id => {
    const b = document.getElementById(id);
    if (b) b.classList.remove('active');
  });
  const map = { 'my-tests':'tab-my', 'public':'tab-pub', 'coded':'tab-coded-btn' };
  const activeBtn = document.getElementById(map[tab]);
  if (activeBtn) activeBtn.classList.add('active');

  if (tab === 'public') loadPublic();
}

let pubLoaded = false;
async function loadPublic() {
  if (pubLoaded) return;
  pubLoaded = true;
  try {
    const tests = await DB.getPublicTests();
    document.getElementById('pub-loading').style.display = 'none';
    const container = document.getElementById('pub-container');
    const groups = {};
    tests.forEach(t => { const s = t.subject||'other'; if(!groups[s]) groups[s]=[]; groups[s].push(t); });
    Object.entries(groups).forEach(([subj, arr]) => {
      const sub = getSubject(subj);
      const sec = document.createElement('div');
      sec.className = 'subject-section fade-in-up';
      sec.innerHTML = `
        <div class="subject-header">
          <button class="subject-title-btn" onclick="location.href='subject.html?s=${subj}'">
            <div class="subject-icon ${sub.cls}" style="background:var(--subj-bg,rgba(79,70,229,0.1))">${sub.emoji}</div>
            <div><div class="subject-name">${esc(sub.label)}</div><div class="subject-count">${arr.length} ta test</div></div>
          </button>
          <button class="subject-view-all" onclick="location.href='subject.html?s=${subj}'">Ko'proq â†’</button>
        </div>
        <div class="carousel-wrap">
          <button class="carousel-btn prev">â€¹</button>
          <div class="carousel" id="pc-${subj}"></div>
          <button class="carousel-btn next">â€º</button>
        </div>`;
      container.appendChild(sec);
      const rail = sec.querySelector(`#pc-${subj}`);
      arr.slice(0,10).forEach(t => { rail.appendChild(buildCard(t, sub)); });
      initCarousel(sec.querySelector('.carousel-wrap'));
    });
  } catch(e) { document.getElementById('pub-loading').innerHTML = '<p style="color:var(--text-3)">Yuklanmadi</p>'; }
}

function buildCard(t, sub) {
  const card = document.createElement('div');
  card.className = 'test-card';
  card.innerHTML = `
    <div class="test-card-accent"></div>
    <div class="test-card-icon ${sub.cls}" style="background:var(--subj-bg,rgba(79,70,229,0.1))">${sub.emoji}</div>
    <div class="test-card-title">${esc(t.title)}</div>
    <div class="test-card-stats">
      <span class="test-stat-chip">ğŸ“ ${t.questionCount||0}</span>
      <span class="test-stat-chip">ğŸ‘ï¸ ${t.attempts||0}</span>
      ${t.averageScore?`<span class="test-stat-chip">â­ ${t.averageScore}%</span>`:''}
    </div>
    <a href="test.html?id=${t.id}" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:0.75rem">Boshlash â†’</a>`;
  return card;
}

window.delTest = async function(id) {
  if (!confirm('O\'chirilsinmi?')) return;
  try { await DB.deleteTest(id); Toast.success('O\'chirildi'); setTimeout(() => location.reload(), 1000); }
  catch(e) { Toast.error(e.message); }
};

window.copyCode = function(code) {
  navigator.clipboard.writeText(code).then(() => Toast.info(`Kod nusxalandi: ${code}`));
};

// Enter code
document.getElementById('enter-code-btn').addEventListener('click', async () => {
  const inputs = document.querySelectorAll('#code-inputs input');
  const code = [...inputs].map(i => i.value).join('').toUpperCase().trim();
  if (code.length < 6) { document.getElementById('code-result').innerHTML = '<div class="alert alert-warn">6 xonali kod kiriting</div>'; return; }

  const btn = document.getElementById('enter-code-btn');
  btn.disabled = true; btn.textContent = 'â³';

  try {
    const test = await DB.getTestByCode(code);
    if (!test) {
      document.getElementById('code-result').innerHTML = '<div class="alert alert-error">âŒ Kod topilmadi</div>';
    } else {
      // Save to localStorage
      const unlocked = JSON.parse(localStorage.getItem('tp_unlocked') || '[]');
      if (!unlocked.includes(test.id)) { unlocked.push(test.id); localStorage.setItem('tp_unlocked', JSON.stringify(unlocked)); }
      document.getElementById('code-result').innerHTML = `<div class="alert alert-success">âœ… "${esc(test.title)}" test topildi!</div>`;
      setTimeout(() => { Modal.close('code-modal'); location.href = `test.html?id=${test.id}`; }, 1200);
    }
  } catch(e) {
    document.getElementById('code-result').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
  }
  btn.disabled = false; btn.textContent = 'Qidirish â†’';
});
</script>
</body>
</html>
