<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro â€” Tarix</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
</head>
<body>
<div class="topbar">
  <div class="topbar-brand">TestPro</div>
  <div style="display:flex;gap:0.6rem;align-items:center">
    <button class="theme-toggle">ğŸŒ™</button>
    <button class="hamburger sidebar-toggle"><span></span><span></span><span></span></button>
  </div>
</div>
<div class="sidebar-overlay"></div>
<aside class="sidebar">
  <div style="padding:1.25rem 1rem 0.5rem;border-bottom:1px solid var(--border)">
    <div style="font-family:'Unbounded',sans-serif;font-size:1.2rem;font-weight:900;background:var(--grad-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">TestPro</div>
  </div>
  <div class="sidebar-inner">
    <a onclick="goTo('dashboard.html');return false" href="#" class="sidebar-nav-item">ğŸ“Š Dashboard</a>
    <a onclick="goTo('create.html');return false" href="#" class="sidebar-nav-item">âœï¸ Test yaratish</a>
    <a onclick="goTo('history.html');return false" href="#" class="sidebar-nav-item active">ğŸ“œ Tarix</a>
    <a onclick="goTo('profile.html');return false" href="#" class="sidebar-nav-item">ğŸ‘¤ Profil</a>
  </div>
  <div class="sidebar-footer">
    <div class="user-chip">
      <div class="user-ava" id="ava">?</div>
      <div style="flex:1;min-width:0"><div class="user-chip-name" id="uname">...</div></div>
      <button id="logout-btn" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem">ğŸšª</button>
    </div>
  </div>
</aside>

<main class="main-area">
  <div class="page-hdr">
    <h1>ğŸ“œ Tarix</h1>
    <p>Barcha ishlangan testlar</p>
  </div>

  <div id="loading" style="text-align:center;padding:3rem"><div class="spinner" style="margin:0 auto"></div></div>
  <div id="history-list" style="display:flex;flex-direction:column;gap:0.75rem"></div>
  <div id="empty" class="empty" style="display:none">
    <div class="empty-icon">ğŸ“­</div>
    <h3>Hali test ishlanmagan</h3>
    <a onclick="goTo('index.html');return false" href="#" class="btn btn-primary btn-sm" style="margin-top:1rem">Testlarga o'tish</a>
  </div>
</main>

<!-- Analytics modal -->
<div class="modal-overlay" id="analytics-modal">
  <div class="modal modal-lg" style="max-height:85vh;overflow-y:auto">
    <div class="modal-header" style="position:sticky;top:0;background:var(--bg);z-index:1;padding-bottom:1rem;border-bottom:1px solid var(--border-2);margin-bottom:1.25rem">
      <span class="modal-title" id="an-title">Tahlil</span>
      <button class="modal-close">âœ•</button>
    </div>

    <div class="grid-3" style="margin-bottom:1.5rem">
      <div class="stat-card"><div class="stat-val" id="an-score">0%</div><div class="stat-lbl">Ball</div></div>
      <div class="stat-card"><div class="stat-val" id="an-correct">0/0</div><div class="stat-lbl">To'g'ri</div></div>
      <div class="stat-card"><div class="stat-val" id="an-time">0:00</div><div class="stat-lbl">Vaqt</div></div>
    </div>

    <div id="an-questions"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
(async () => {
  const user = await AuthHelpers.requireAuth('login.html');
  if (!user) return;
  const prof = await DB.getUser(user.uid).catch(() => null);
  document.getElementById('ava').textContent = (prof?.name || user.displayName || 'U')[0].toUpperCase();
  document.getElementById('uname').textContent = prof?.name || user.displayName || '...';

  const results = await DB.getResults({ userId: user.uid, limit: 100 }).catch(() => []);
  document.getElementById('loading').style.display = 'none';

  if (!results.length) {
    document.getElementById('empty').style.display = 'block'; return;
  }

  const list = document.getElementById('history-list');
  list.innerHTML = results.map((r, i) => {
    const scoreClass = r.score >= 80 ? 'score-high' : r.score >= 50 ? 'score-mid' : 'score-low';
    return `
      <div class="history-item fade-in" style="animation-delay:${i*0.04}s">
        <div class="history-info">
          <div class="history-title">${esc(r.testTitle || 'Test')}</div>
          <div class="history-meta">
            ğŸ“… ${fmtDate(r.completedAt)} &nbsp;Â·&nbsp;
            ğŸ“ ${r.total||0} savol &nbsp;Â·&nbsp;
            â±ï¸ ${fmtTime(r.duration||0)} &nbsp;Â·&nbsp;
            <span class="${r.passed?'':''}badge ${r.passed?'badge-green':'badge-rose'} " style="font-size:0.68rem">
              ${r.passed ? 'âœ“ O\'tdi' : 'âœ— O\'tmadi'}
            </span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;flex-shrink:0">
          <span class="score-pill ${scoreClass}">${r.score||0}%</span>
          <button class="btn btn-secondary btn-sm" onclick="openAnalytics('${r.id}')">ğŸ“Š Tahlil</button>
        </div>
      </div>`;
  }).join('');
})();

async function openAnalytics(resultId) {
  Modal.open('analytics-modal');
  document.getElementById('an-questions').innerHTML = '<div style="text-align:center;padding:2rem"><div class="spinner" style="margin:0 auto"></div></div>';

  try {
    const rDoc = await db.collection('results').doc(resultId).get();
    if (!rDoc.exists) { Toast.error('Natija topilmadi'); return; }
    const r = rDoc.data();
    const testDoc = await DB.getTest(r.testId);
    const questions = testDoc ? await DB.getQuestions(r.testId) : [];

    document.getElementById('an-title').textContent  = r.testTitle || 'Tahlil';
    document.getElementById('an-score').textContent  = (r.score||0) + '%';
    document.getElementById('an-correct').textContent= `${r.correct||0}/${r.total||0}`;
    document.getElementById('an-time').textContent   = fmtTime(r.duration||0);

    const answers = r.answers || {};
    document.getElementById('an-questions').innerHTML = questions.map((q, i) => {
      const ua  = answers[q.id];
      const isc = q.type !== 'text' && ua === q.correct;
      const badge = q.type === 'text' ? `<span class="badge badge-teal">Matn</span>` :
                    isc ? `<span class="badge badge-green">âœ“ To'g'ri</span>` :
                          `<span class="badge badge-rose">âœ— Noto'g'ri</span>`;
      const optsHtml = q.type === 'text'
        ? `<div style="margin-top:0.5rem;padding:0.65rem;background:var(--bg-2);border-radius:var(--radius-xs);font-size:0.85rem">${esc(ua||'â€”')}</div>`
        : q.options.map((o, j) => {
            const cls = j === q.correct ? 'correct' : (j === ua && j !== q.correct ? 'wrong' : '');
            return `<div class="opt-btn ${cls} disabled" style="padding:0.65rem 0.9rem;margin-bottom:0.35rem">
              <span class="opt-letter" style="width:22px;height:22px;font-size:0.68rem">${String.fromCharCode(65+j)}</span>${esc(o)} ${j===q.correct?' âœ“':''}
            </div>`;
          }).join('');
      const expl = q.explanation ? `<div class="expl-box">ğŸ’¡ ${esc(q.explanation)}</div>` : '';
      return `<div style="background:var(--bg-2);border:1px solid var(--border-2);border-radius:var(--radius);padding:1.1rem;margin-bottom:0.85rem">
        <div style="display:flex;justify-content:space-between;gap:0.5rem;margin-bottom:0.75rem;flex-wrap:wrap">
          <div style="font-size:0.88rem;font-weight:600;flex:1">${i+1}. ${esc(q.text)}</div>${badge}
        </div>
        ${optsHtml}${expl}
      </div>`;
    }).join('') || '<p style="color:var(--text-3);text-align:center;padding:1rem">Savollar topilmadi</p>';
  } catch(e) {
    document.getElementById('an-questions').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
  }
}
window.openAnalytics = openAnalytics;
</script>
</body>
</html>
