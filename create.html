<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro â€” Test Yaratish</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
<style>
.create-layout{display:grid;grid-template-columns:1fr 300px;gap:1.5rem;align-items:start}
.settings-sticky{position:sticky;top:1.5rem}
@media(max-width:900px){.create-layout{grid-template-columns:1fr}.settings-sticky{position:static}}

/* Subject selector */
.subj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:0.5rem;margin-bottom:0.75rem}
.subj-btn{padding:0.55rem 0.65rem;border-radius:var(--radius-sm);border:1.5px solid var(--border-2);background:var(--bg-2);cursor:pointer;transition:all var(--t);text-align:center;font-size:0.78rem;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-2)}
.subj-btn:hover,.subj-btn.active{border-color:var(--accent);background:rgba(79,70,229,0.08);color:var(--accent)}
.subj-btn .emoji{display:block;font-size:1.2rem;margin-bottom:0.2rem}

/* Visibility */
.vis-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem}
.vis-btn{padding:0.7rem 0.4rem;border-radius:12px;border:2px solid rgba(0,0,0,0.09);background:#f8f8ff;cursor:pointer;transition:all 0.2s;text-align:center;font-size:0.78rem;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;color:#6b7280;opacity:0.75}
[data-theme="dark"] .vis-btn{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.12);color:#9ca3af}
.vis-btn:hover{opacity:1;border-color:rgba(124,58,237,0.4)}
.vis-btn.active{border-color:#7c3aed !important;background:rgba(124,58,237,0.12) !important;color:#7c3aed !important;opacity:1;box-shadow:0 0 0 3px rgba(124,58,237,0.15)}
.vis-btn .vis-icon{display:block;font-size:1.3rem;margin-bottom:0.25rem}

/* Import hint */
.code-block{background:var(--bg-2);border:1px solid var(--border-2);border-radius:var(--radius-sm);padding:0.85rem;font-family:monospace;font-size:0.78rem;color:var(--text-2);white-space:pre;overflow-x:auto;line-height:1.65}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-brand">TestPro</div>
  <div style="display:flex;gap:0.6rem;align-items:center">
    <button class="theme-toggle">ğŸŒ™</button>
    <button class="hamburger sidebar-toggle"><span></span><span></span><span></span></button>
  </div>
</div>
<div class="sidebar-overlay"></div>
<aside class="sidebar">
  <div style="padding:1.25rem 1rem 0.5rem;border-bottom:1px solid var(--border)">
    <div style="font-family:'Unbounded',sans-serif;font-size:1.2rem;font-weight:900;background:var(--grad-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">TestPro</div>
  </div>
  <div class="sidebar-inner">
    <a onclick="goTo('dashboard.html');return false" href="#" class="sidebar-nav-item">ğŸ“Š Dashboard</a>
    <a onclick="goTo('create.html');return false" href="#" class="sidebar-nav-item active">âœï¸ Test yaratish</a>
    <a onclick="goTo('history.html');return false" href="#" class="sidebar-nav-item">ğŸ“œ Tarix</a>
  </div>
  <div class="sidebar-footer">
    <div class="user-chip">
      <div class="user-ava" id="ava">?</div>
      <div style="flex:1;min-width:0"><div class="user-chip-name" id="uname">...</div></div>
      <a onclick="goTo('profile.html');return false" href="#" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem">ğŸ‘¤</a>
      <button id="logout-btn" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem">ğŸšª</button>
    </div>
  </div>
</aside>

<main class="main-area">
  <div class="page-hdr" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem">
    <div>
      <h1 id="page-title">Yangi test yaratish</h1>
      <p>Savollar qo'shing va sozlang</p>
    </div>
    <div style="display:flex;gap:0.65rem;flex-wrap:wrap">
      <a onclick="goTo('dashboard.html');return false" href="#" class="btn btn-ghost btn-sm">â† Orqaga</a>
      <button class="btn btn-secondary btn-sm" onclick="Modal.open('import-modal')">ğŸ“„ Import</button>
      <button class="btn btn-primary" id="save-btn">ğŸ’¾ Saqlash</button>
    </div>
  </div>
  <div id="save-alert" style="margin-bottom:1rem"></div>

  <div class="create-layout">
    <!-- LEFT: test info + questions -->
    <div>
      <!-- Test info -->
      <div class="glass-card" style="margin-bottom:1.25rem">
        <h3 style="font-size:0.95rem;margin-bottom:1.1rem;font-family:'Unbounded',sans-serif">ğŸ“‹ Test haqida</h3>
        <div class="form-group">
          <label class="form-label">Test nomi *</label>
          <input id="t-title" type="text" class="form-input" placeholder="Masalan: HTML & CSS asoslar"/>
        </div>
        <div class="form-group">
          <label class="form-label">Tavsif (ixtiyoriy)</label>
          <textarea id="t-desc" class="form-input" rows="2" placeholder="Test haqida qisqacha..."></textarea>
        </div>

        <!-- Subject selector -->
        <div class="form-group">
          <label class="form-label">Fan / Guruh *</label>
          <div class="subj-grid" id="subj-grid"></div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <input id="custom-subj" type="text" class="form-input" placeholder="Boshqa fan nomi yozing..." style="flex:1"/>
            <button class="btn btn-secondary btn-sm" onclick="setCustomSubj()">âœ“</button>
          </div>
        </div>
        <div id="selected-subj" style="display:none;margin-top:-0.5rem;margin-bottom:0.75rem"></div>
      </div>

      <!-- Questions -->
      <div id="q-container"></div>

      <!-- Add question buttons -->
      <div style="border:2px dashed rgba(124,58,237,0.3);border-radius:16px;padding:1.35rem;text-align:center;margin-top:1rem;background:rgba(124,58,237,0.03);transition:all 0.2s" id="add-area">
        <div style="font-size:1.5rem;margin-bottom:0.4rem">â•</div>
        <p style="font-size:0.82rem;color:#6b7280;margin-bottom:1rem;font-weight:600">Savol turi tanlang</p>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem">
          <button onclick="addQ('multiple')" style="padding:0.75rem 0.4rem;border-radius:12px;border:2px solid rgba(124,58,237,0.2);background:rgba(124,58,237,0.06);color:#7c3aed;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.78rem;transition:all 0.2s" onmouseover="this.style.background='rgba(124,58,237,0.15)'" onmouseout="this.style.background='rgba(124,58,237,0.06)'">
            <div style="font-size:1.3rem;margin-bottom:0.25rem">â­•</div>Ko'p tanlov
          </button>
          <button onclick="addQ('truefalse')" style="padding:0.75rem 0.4rem;border-radius:12px;border:2px solid rgba(16,185,129,0.2);background:rgba(16,185,129,0.06);color:#059669;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.78rem;transition:all 0.2s" onmouseover="this.style.background='rgba(16,185,129,0.15)'" onmouseout="this.style.background='rgba(16,185,129,0.06)'">
            <div style="font-size:1.3rem;margin-bottom:0.25rem">âœ…</div>Ha / Yo'q
          </button>
          <button onclick="addQ('text')" style="padding:0.75rem 0.4rem;border-radius:12px;border:2px solid rgba(245,158,11,0.2);background:rgba(245,158,11,0.06);color:#d97706;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.78rem;transition:all 0.2s" onmouseover="this.style.background='rgba(245,158,11,0.15)'" onmouseout="this.style.background='rgba(245,158,11,0.06)'">
            <div style="font-size:1.3rem;margin-bottom:0.25rem">ğŸ“</div>Matn
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT: settings -->
    <div class="settings-sticky">
      <div class="glass-card">
        <h3 style="font-size:0.95rem;margin-bottom:1.1rem;font-family:'Unbounded',sans-serif">âš™ï¸ Sozlamalar</h3>

        <!-- Visibility -->
        <div class="form-group">
          <label class="form-label">Ko'rinish</label>
          <div class="vis-grid">
            <button class="vis-btn active" data-vis="public">
              <span class="vis-icon">ğŸŒ</span>Ommaviy
            </button>
            <button class="vis-btn" data-vis="private">
              <span class="vis-icon">ğŸ”’</span>Shaxsiy
            </button>
          </div>
          <div id="code-hint" style="margin-top:0.65rem;padding:0.6rem 0.85rem;border-radius:10px;background:rgba(124,58,237,0.08);border:1px dashed rgba(124,58,237,0.3);font-size:0.78rem;color:#7c3aed;font-weight:600">
            ğŸ”‘ Barcha testlar ulashish kodi bilan birga saqlanadi
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Vaqt limiti (daqiqa)</label>
          <input id="t-time" type="number" class="form-input" value="0" min="0" max="180" placeholder="0 = cheksiz"/>
        </div>

        <div class="form-group">
          <label class="form-label">O'tish bali (%)</label>
          <input id="t-pass" type="number" class="form-input" value="60" min="0" max="100"/>
        </div>

        <div class="divider"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
          <span class="form-label" style="margin:0">Savollarni aralashtirish</span>
          <label class="toggle"><input type="checkbox" id="t-shuffle"/><span class="toggle-slider"></span></label>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="form-label" style="margin:0">Natija ko'rsatish</span>
          <label class="toggle"><input type="checkbox" id="t-result" checked/><span class="toggle-slider"></span></label>
        </div>

        <div class="divider"></div>

        <div style="text-align:center;padding:0.75rem;background:var(--bg-2);border-radius:var(--radius-sm);margin-bottom:1rem">
          <div style="font-family:'Unbounded',sans-serif;font-size:1.4rem;font-weight:900;color:var(--accent)" id="q-count">0</div>
          <div style="font-size:0.72rem;color:var(--text-3);font-weight:600">ta savol</div>
        </div>

        <button class="btn btn-primary" style="width:100%;justify-content:center" id="save-btn-2">ğŸ’¾ Saqlash</button>
      </div>
    </div>
  </div>
</main>

<!-- Import modal â€” beautiful redesign -->
<div class="modal-overlay" id="import-modal">
  <div class="modal modal-md">
    <div class="modal-header">
      <span class="modal-title">ğŸ“¥ Savollarni import qilish</span>
      <button class="modal-close">âœ•</button>
    </div>

    <!-- Tab switcher -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:1.25rem">
      <button id="imp-tab-txt" onclick="switchImpTab('txt')" style="padding:0.7rem;border-radius:12px;border:2px solid rgba(79,70,229,0.5);background:rgba(79,70,229,0.1);color:var(--accent);font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.85rem;transition:all 0.2s">
        ğŸ“ Matn yozish
      </button>
      <button id="imp-tab-file" onclick="switchImpTab('file')" style="padding:0.7rem;border-radius:12px;border:2px solid var(--border-2);background:var(--bg-2);color:var(--text-3);font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.85rem;transition:all 0.2s">
        ğŸ“ Fayl yuklash
      </button>
    </div>

    <!-- Text tab -->
    <div id="imp-txt">
      <!-- Format tabs -->
      <div style="display:flex;gap:0.4rem;margin-bottom:0.85rem;overflow-x:auto;padding-bottom:3px">
        <button onclick="showFmt(0,this)" class="fmt-tab" style="padding:0.35rem 0.75rem;border-radius:99px;border:1.5px solid rgba(79,70,229,0.4);background:rgba(79,70,229,0.1);color:var(--accent);font-size:0.72rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif">A) * format</button>
        <button onclick="showFmt(1,this)" class="fmt-tab" style="padding:0.35rem 0.75rem;border-radius:99px;border:1.5px solid var(--border-2);background:var(--bg-2);color:var(--text-3);font-size:0.72rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif">1) [+] format</button>
        <button onclick="showFmt(2,this)" class="fmt-tab" style="padding:0.35rem 0.75rem;border-radius:99px;border:1.5px solid var(--border-2);background:var(--bg-2);color:var(--text-3);font-size:0.72rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif">Ha/Yo'q</button>
      </div>
      <div class="code-block" id="fmt-preview" style="font-size:0.75rem;margin-bottom:0.85rem;max-height:120px;overflow-y:auto">1. Savol matni?
A) Variant A
B) To'g'ri variant *
C) Variant C
D) Variant D
Izoh: Bu yerda tushuntirish.</div>
      <div style="font-size:0.72rem;color:var(--text-3);margin-bottom:0.75rem">ğŸ’¡ <b>*</b> yoki <b>[+]</b> = to'g'ri javob &nbsp;Â·&nbsp; <b>Izoh:</b> = tushuntirish (ixtiyoriy)</div>
      <textarea id="imp-textarea" class="form-input" rows="8" style="font-family:monospace;font-size:0.83rem;resize:vertical" placeholder="1. Savol matni?
A) Variant
B) To'g'ri javob *
C) Variant
D) Variant
Izoh: Tushuntirish...

2. Keyingi savol..."></textarea>
      <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1rem">
        <button class="btn btn-ghost" data-close-modal>Bekor</button>
        <button class="btn btn-primary" onclick="importFromText()">âœ… Importlash</button>
      </div>
    </div>

    <!-- File tab -->
    <div id="imp-file" style="display:none">
      <div id="drop-zone" style="border:2.5px dashed rgba(79,70,229,0.35);border-radius:16px;padding:2rem 1.5rem;text-align:center;cursor:pointer;transition:all 0.25s;background:rgba(79,70,229,0.03);user-select:none;position:relative">
        <div style="pointer-events:none">
          <div style="width:60px;height:60px;border-radius:50%;background:rgba(79,70,229,0.1);display:flex;align-items:center;justify-content:center;font-size:1.6rem;margin:0 auto 0.85rem">ğŸ“</div>
          <div style="font-weight:800;font-size:0.95rem;margin-bottom:0.3rem;color:var(--text)">Faylni bu yerga tashlang</div>
          <div style="font-size:0.78rem;color:var(--text-3);margin-bottom:1rem">yoki tugmani bosing</div>
        </div>
        <label for="file-input" style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.7rem 1.5rem;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:0.85rem;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif">
          ğŸ“‚ .txt fayl tanlash
        </label>
        <div style="font-size:0.7rem;color:var(--text-3);margin-top:0.75rem">Format: .txt (plain text)</div>
        <input type="file" id="file-input" accept=".txt,.text" style="display:none" onchange="handleFileImport(this)"/>
      </div>
      <div id="file-result" style="margin-top:0.85rem"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:0.85rem">
        <button class="btn btn-ghost" data-close-modal>Yopish</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
/* ============================================================
   CREATE PAGE LOGIC
   ============================================================ */
let questions    = [];
let selectedSubj = '';
let selectedVis  = 'public';
let currentUser  = null;
let editId       = null;
const params     = new URLSearchParams(location.search);

(async () => {
  currentUser = await AuthHelpers.requireAuth('login.html');
  if (!currentUser) return;
  const prof = await DB.getUser(currentUser.uid).catch(() => null);
  document.getElementById('ava').textContent = (prof?.name || currentUser.displayName || 'U')[0].toUpperCase();
  document.getElementById('uname').textContent = prof?.name || currentUser.displayName || '...';

  buildSubjGrid();
  bindVisButtons();

  editId = params.get('id');
  if (editId) {
    document.getElementById('page-title').textContent = 'Testni tahrirlash';
    await loadEdit(editId);
  } else {
    addQ('multiple');
  }
})();

/* â”€â”€ Subject grid â”€â”€ */
function buildSubjGrid() {
  const grid = document.getElementById('subj-grid');
  Object.entries(SUBJECTS).forEach(([key, s]) => {
    const btn = document.createElement('button');
    btn.className = 'subj-btn';
    btn.dataset.key = key;
    btn.innerHTML = `<span class="emoji">${s.emoji}</span>${s.label}`;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.subj-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedSubj = key;
      showSelSubj(key);
    });
    grid.appendChild(btn);
  });
}

function showSelSubj(key) {
  const el = document.getElementById('selected-subj');
  if (!key) { el.style.display = 'none'; return; }
  const s = getSubject(key);
  el.style.display = 'flex';
  el.innerHTML = `<span class="subj-badge ${s.cls}">${s.emoji} ${s.label}</span> <span style="font-size:0.8rem;color:var(--text-3);margin-left:0.5rem">seÃ§ildi</span>`;
}

window.setCustomSubj = function() {
  const val = document.getElementById('custom-subj').value.trim();
  if (!val) return;
  document.querySelectorAll('.subj-btn').forEach(b => b.classList.remove('active'));
  selectedSubj = val.toLowerCase().replace(/\s+/g, '-');
  const el = document.getElementById('selected-subj');
  el.style.display = 'flex';
  el.innerHTML = `<span class="badge badge-gray">ğŸ“ ${esc(val)}</span> <span style="font-size:0.8rem;color:var(--text-3);margin-left:0.5rem">seÃ§ildi</span>`;
};

/* â”€â”€ Visibility â”€â”€ */
function bindVisButtons() {
  document.querySelectorAll('.vis-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.vis-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedVis = btn.dataset.vis;
    });
  });
}

/* â”€â”€ Add question â”€â”€ */
window.addQ = function(type = 'multiple') {
  const q = {
    id:          Date.now() + Math.random(),
    type,
    text:        '',
    options:     type === 'multiple'  ? ['','','',''] :
                 type === 'truefalse' ? ['Ha',"Yo'q"] : [],
    correct:     0,
    explanation: '',
    points:      1,
  };
  questions.push(q);
  renderAll();
  setTimeout(() => {
    const cards = document.querySelectorAll('.q-card');
    if (cards.length) cards[cards.length-1].scrollIntoView({ behavior:'smooth', block:'nearest' });
  }, 80);
};

function renderAll() {
  document.getElementById('q-container').innerHTML = '';
  questions.forEach((q, i) => renderCard(q, i));
  document.getElementById('q-count').textContent = questions.length;
  document.getElementById('q-count-2') && (document.getElementById('q-count-2').textContent = questions.length);
}

function renderCard(q, idx) {
  const wrap = document.getElementById('q-container');
  const typeLabel = { multiple:'Ko\'p tanlov', truefalse:'Ha/Yo\'q', text:'Matn' };
  const div = document.createElement('div');
  div.className = 'q-card fade-in';
  div.dataset.qid = q.id;

  div.innerHTML = `
    <div class="q-card-header">
      <div class="q-num">${idx+1}</div>
      <div class="q-type-tabs">
        ${['multiple','truefalse','text'].map(t =>
          `<button class="q-type-tab ${q.type===t?'active':''}" onclick="chType('${q.id}','${t}')">${typeLabel[t]}</button>`
        ).join('')}
      </div>
      <button class="btn btn-ghost b
