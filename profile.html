<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro ‚Äî Profil</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;
  background:linear-gradient(135deg,#f5f3ff 0%,#fce7f3 50%,#eff6ff 100%);color:#1a1a2e}
[data-theme="dark"] body{background:linear-gradient(135deg,#0d0820,#140a20,#080d1a);color:#e8e0ff}
.nav{position:fixed;top:0;left:0;right:0;height:54px;z-index:500;
  display:flex;align-items:center;justify-content:space-between;padding:0 1rem;
  background:rgba(245,243,255,.92);backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(124,58,237,.1)}
[data-theme="dark"] .nav{background:rgba(13,8,32,.92)}
.logo{font-family:'Unbounded',sans-serif;font-size:1.1rem;font-weight:900;cursor:pointer;
  background:linear-gradient(135deg,#7c3aed,#ec4899);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav-r{display:flex;gap:.4rem;align-items:center}
.nbtn{padding:.38rem .8rem;border-radius:8px;border:1.5px solid rgba(0,0,0,.1);
  background:#fff;cursor:pointer;font-size:.78rem;font-weight:700;
  font-family:'Plus Jakarta Sans',sans-serif;color:#374151;transition:all .2s}
[data-theme="dark"] .nbtn{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12);color:#c4b5fd}
.nbtn:hover{border-color:#7c3aed;color:#7c3aed}
.tbtn{width:31px;height:31px;border-radius:8px;border:1.5px solid rgba(0,0,0,.1);
  background:#fff;cursor:pointer;font-size:.82rem}
[data-theme="dark"] .tbtn{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15)}
.page{padding:70px 1rem 3rem;max-width:500px;margin:0 auto}

/* Avatar */
.ava-wrap{text-align:center;margin-bottom:1.5rem}
.ava-label{display:inline-block;width:96px;height:96px;border-radius:50%;cursor:pointer;
  background:linear-gradient(135deg,#7c3aed,#ec4899);
  display:flex;align-items:center;justify-content:center;
  font-family:'Unbounded',sans-serif;font-size:2.2rem;font-weight:900;color:#fff;
  position:relative;overflow:hidden;margin:0 auto .5rem;
  box-shadow:0 8px 24px rgba(124,58,237,.3)}
.ava-label img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.ava-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity .2s;font-size:1.3rem}
.ava-label:hover .ava-overlay{opacity:1}
.ava-hint{font-size:.73rem;color:#9ca3af}

/* Card */
.card{background:#fff;border:1px solid rgba(0,0,0,.07);border-radius:18px;
  padding:1.25rem;margin-bottom:.85rem;box-shadow:0 4px 16px rgba(124,58,237,.06)}
[data-theme="dark"] .card{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.09)}
.card-h{font-size:.88rem;font-weight:800;margin-bottom:1rem;
  display:flex;align-items:center;gap:.35rem}

label.fl{display:block;font-size:.78rem;font-weight:700;color:#374151;margin-bottom:.3rem}
[data-theme="dark"] label.fl{color:#c4b5fd}
input.fi{width:100%;padding:.7rem .9rem;border-radius:11px;border:1.5px solid rgba(0,0,0,.09);
  background:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;
  color:#111827;outline:none;transition:border-color .2s;margin-bottom:.75rem}
[data-theme="dark"] input.fi{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.12);color:#e8e0ff}
input.fi:focus{border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.1)}
input.fi:disabled{opacity:.6;cursor:default}
.sbtn{width:100%;padding:.78rem;border-radius:12px;border:none;cursor:pointer;
  background:linear-gradient(135deg,#7c3aed,#ec4899);color:#fff;
  font-weight:800;font-size:.88rem;font-family:'Plus Jakarta Sans',sans-serif;transition:all .2s}
.sbtn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(124,58,237,.3)}
.sbtn:disabled{opacity:.5;cursor:not-allowed;transform:none}

.dbtn{width:100%;padding:.78rem;border-radius:12px;border:1.5px solid rgba(239,68,68,.25);
  background:rgba(239,68,68,.06);cursor:pointer;color:#ef4444;
  font-weight:800;font-size:.88rem;font-family:'Plus Jakarta Sans',sans-serif;transition:all .2s}
.dbtn:hover{background:rgba(239,68,68,.14)}

.al{padding:.65rem .9rem;border-radius:10px;font-size:.8rem;font-weight:600;
  margin-bottom:.75rem;text-align:center;display:none}
.al-s{background:rgba(16,185,129,.1);color:#059669;border:1px solid rgba(16,185,129,.2)}
.al-e{background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2)}
.al.show{display:block}

/* Stats row */
.stats-r{display:grid;grid-template-columns:repeat(3,1fr);gap:.55rem;margin-bottom:.85rem}
.sg{background:#fff;border:1px solid rgba(0,0,0,.07);border-radius:13px;
  padding:.75rem .5rem;text-align:center}
[data-theme="dark"] .sg{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.09)}
.sv{font-family:'Unbounded',sans-serif;font-size:1.2rem;font-weight:900;color:#7c3aed}
.sl{font-size:.65rem;color:#9ca3af;text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-top:.1rem}
</style>
</head>
<body>
<nav class="nav">
  <div class="logo" onclick="goTo('index.html')">TestPro</div>
  <div class="nav-r">
    <button class="nbtn" onclick="goTo('dashboard.html')">‚Üê Dashboard</button>
    <button class="tbtn" id="tbtn">üåô</button>
  </div>
</nav>
<div class="page">

  <!-- Avatar -->
  <div class="ava-wrap">
    <label class="ava-label" for="ava-file" id="ava-el">
      <span id="ava-text">?</span>
      <div class="ava-overlay">üì∑</div>
    </label>
    <input type="file" id="ava-file" accept="image/*" style="display:none" onchange="uploadAva(this)"/>
    <div class="ava-hint">üì∑ Bosib rasm yuklang</div>
  </div>

  <!-- Stats -->
  <div class="stats-r">
    <div class="sg"><div class="sv" id="st-t">0</div><div class="sl">Testlar</div></div>
    <div class="sg"><div class="sv" id="st-d">0</div><div class="sl">Ishlangan</div></div>
    <div class="sg"><div class="sv" id="st-a">‚Äî</div><div class="sl">O'rtacha</div></div>
  </div>

  <!-- Edit profile -->
  <div class="card">
    <div class="card-h">üë§ Profilni tahrirlash</div>
    <div id="alert" class="al"></div>
    <label class="fl">Ism Familiya</label>
    <input class="fi" type="text" id="p-name" placeholder="Ism Familiya"/>
    <label class="fl">Email</label>
    <input class="fi" type="email" id="p-email" disabled/>
    <button class="sbtn" id="save-btn" onclick="saveProfile()">üíæ Saqlash</button>
  </div>

  <!-- Change password -->
  <div class="card">
    <div class="card-h">üîê Parolni o'zgartirish</div>
    <label class="fl">Yangi parol</label>
    <input class="fi" type="password" id="np1" placeholder="Yangi parol (min 6 belgi)"/>
    <label class="fl">Parolni tasdiqlash</label>
    <input class="fi" type="password" id="np2" placeholder="Parolni qayta kiriting"/>
    <button class="sbtn" onclick="changePass()">üîê Parolni o'zgartirish</button>
  </div>

  <!-- Logout -->
  <div class="card">
    <div class="card-h">‚öôÔ∏è Hisobni boshqarish</div>
    <button class="dbtn" onclick="doLogout()">üö™ Chiqish</button>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script>
const T={get(){return localStorage.getItem('tp_theme')||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light')},
  set(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('tp_theme',t);
    document.getElementById('tbtn').textContent=t==='dark'?'‚òÄÔ∏è':'üåô'},
  toggle(){this.set(this.get()==='dark'?'light':'dark')}};
T.set(T.get());
document.getElementById('tbtn').onclick=()=>T.toggle();

let currentUser=null;

function showAl(msg,type='s'){
  const el=document.getElementById('alert');
  el.textContent=msg;el.className='al al-'+type+' show';
  setTimeout(()=>el.className='al',3500);
}

(async()=>{
  currentUser=await AuthHelpers.requireAuth('login.html');
  if(!currentUser)return;

  const prof=await DB.getUser(currentUser.uid).catch(()=>null);
  const name=prof?.name||currentUser.displayName||'';

  document.getElementById('p-name').value=name;
  document.getElementById('p-email').value=currentUser.email||'';

  /* Avatar */
  const avaEl=document.getElementById('ava-el');
  const avaText=document.getElementById('ava-text');
  if(prof?.avatarUrl){
    avaText.innerHTML=`<img src="${prof.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`;
  }else{
    avaText.textContent=(name||'U')[0].toUpperCase();
  }

  /* Stats */
  try{
    const [myTests,results]=await Promise.all([
      DB.getMyTests(currentUser.uid),
      DB.getMyResults(currentUser.uid,100)
    ]);
    document.getElementById('st-t').textContent=myTests.length;
    document.getElementById('st-d').textContent=results.length;
    if(results.length){
      const avg=Math.round(results.reduce((s,r)=>s+(r.score||0),0)/results.length);
      document.getElementById('st-a').textContent=avg+'%';
    }
  }catch(e){}
})();

window.uploadAva=async(inp)=>{
  const file=inp.files[0];
  if(!file||!currentUser)return;
  showAl('‚è≥ Rasm yuklanmoqda...','s');
  /* Compress to 200x200 */
  const img=new Image();
  const reader=new FileReader();
  reader.onload=e=>{img.src=e.target.result;};
  reader.readAsDataURL(file);
  img.onload=async()=>{
    const canvas=document.createElement('canvas');
    canvas.width=canvas.height=200;
    const ctx=canvas.getContext('2d');
    const size=Math.min(img.width,img.height);
    const sx=(img.width-size)/2,sy=(img.height-size)/2;
    ctx.drawImage(img,sx,sy,size,size,0,0,200,200);
    const base64=canvas.toDataURL('image/jpeg',.7);
    try{
      await DB.updateUser(currentUser.uid,{avatarUrl:base64});
      document.getElementById('ava-text').innerHTML=`<img src="${base64}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`;
      showAl('‚úÖ Rasm saqlandi!','s');
    }catch(e){showAl('‚ùå '+e.message,'e');}
  };
};

window.saveProfile=async()=>{
  const name=document.getElementById('p-name').value.trim();
  if(!name){showAl('Ism kiriting','e');return;}
  const btn=document.getElementById('save-btn');
  btn.disabled=true;btn.textContent='‚è≥...';
  try{
    await DB.updateUser(currentUser.uid,{name});
    await currentUser.updateProfile({displayName:name});
    showAl('‚úÖ Profil yangilandi!','s');
  }catch(e){showAl('‚ùå '+e.message,'e');}
  btn.disabled=false;btn.textContent='üíæ Saqlash';
};

window.changePass=async()=>{
  const p1=document.getElementById('np1').value;
  const p2=document.getElementById('np2').value;
  if(!p1||p1.length<6){showAl('Parol kamida 6 belgi','e');return;}
  if(p1!==p2){showAl('Parollar mos emas','e');return;}
  try{
    await currentUser.updatePassword(p1);
    document.getElementById('np1').value='';
    document.getElementById('np2').value='';
    showAl('‚úÖ Parol o\'zgartirildi!','s');
  }catch(e){
    if(e.code==='auth/requires-recent-login')showAl('Iltimos qayta kiring','e');
    else showAl('‚ùå '+e.message,'e');
  }
};

window.doLogout=async()=>{
  if(!confirm('Chiqmoqchimisiz?'))return;
  await auth.signOut().catch(()=>{});
  goTo('login.html');
};
</script>
</body>
</html>
