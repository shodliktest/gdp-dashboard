<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro â€” Profil</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
<style>
.profile-wrap{max-width:600px;margin:0 auto}
.profile-hero{background:var(--bg-card);border:1px solid var(--border-2);border-radius:var(--radius-lg);padding:2rem;margin-bottom:1.25rem;display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap}
[data-theme="dark"] .profile-hero{background:var(--bg-2);border-color:var(--border)}
.pwd-wrap{position:relative}
.pwd-wrap .form-input{padding-right:3rem}
.pwd-eye{position:absolute;right:0.85rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-3);font-size:1rem}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-brand">TestPro</div>
  <div style="display:flex;gap:0.6rem;align-items:center">
    <button class="theme-toggle">ğŸŒ™</button>
    <button class="hamburger sidebar-toggle"><span></span><span></span><span></span></button>
  </div>
</div>
<div class="sidebar-overlay"></div>
<aside class="sidebar">
  <div style="padding:1.25rem 1rem 0.5rem;border-bottom:1px solid var(--border)">
    <div style="font-family:'Unbounded',sans-serif;font-size:1.2rem;font-weight:900;background:var(--grad-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">TestPro</div>
  </div>
  <div class="sidebar-inner">
    <a onclick="goTo('dashboard.html');return false" href="#" class="sidebar-nav-item">ğŸ“Š Dashboard</a>
    <a onclick="goTo('create.html');return false" href="#" class="sidebar-nav-item">âœï¸ Test yaratish</a>
    <a onclick="goTo('history.html');return false" href="#" class="sidebar-nav-item">ğŸ“œ Tarix</a>
    <a onclick="goTo('profile.html');return false" href="#" class="sidebar-nav-item active">ğŸ‘¤ Profil</a>
  </div>
  <div class="sidebar-footer">
    <div class="user-chip">
      <div class="user-ava" id="ava">?</div>
      <div style="flex:1;min-width:0"><div class="user-chip-name" id="uname">...</div></div>
      <button id="logout-btn" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem">ğŸšª</button>
    </div>
  </div>
</aside>

<main class="main-area">
  <div class="page-hdr"><h1>ğŸ‘¤ Profil</h1><p>Shaxsiy ma'lumotlaringiz</p></div>

  <div class="profile-wrap">

    <!-- Avatar + Basic info -->
    <div class="profile-hero">
      <div>
        <div class="profile-avatar-wrap" id="avatar-wrap" onclick="document.getElementById('avatar-file').click()">
          <div id="avatar-text" style="font-size:2.2rem;font-weight:900;font-family:'Unbounded',sans-serif">?</div>
          <div class="avatar-edit-overlay">ğŸ“·</div>
        </div>
        <input type="file" id="avatar-file" accept="image/*" style="display:none" onchange="uploadAvatar(this)"/>
        <div style="text-align:center;margin-top:0.5rem;font-size:0.72rem;color:var(--text-3)">Rasm yuklash</div>
      </div>
      <div style="flex:1;min-width:0">
        <div id="profile-name" style="font-family:'Unbounded',sans-serif;font-size:1.3rem;font-weight:900;margin-bottom:0.25rem">...</div>
        <div id="profile-email" style="font-size:0.85rem;color:var(--text-2);margin-bottom:0.5rem">...</div>
        <div id="profile-role-badge"></div>
      </div>
    </div>

    <div id="profile-alert" style="margin-bottom:1rem"></div>

    <!-- Edit profile -->
    <div class="glass-card" style="margin-bottom:1.25rem">
      <h3 style="font-size:0.95rem;margin-bottom:1.1rem;font-family:'Unbounded',sans-serif">âœï¸ Ma'lumotlarni tahrirlash</h3>
      <div class="form-group">
        <label class="form-label">To'liq ism</label>
        <input id="p-name" type="text" class="form-input" placeholder="Ism Familiya"/>
      </div>
      <div class="form-group">
        <label class="form-label">Yosh</label>
        <input id="p-age" type="number" class="form-input" min="5" max="120" placeholder="Yoshingiz"/>
      </div>
      <div class="form-group">
        <label class="form-label">Email (o'zgartirib bo'lmaydi)</label>
        <input id="p-email" type="email" class="form-input" disabled style="opacity:0.6;cursor:not-allowed"/>
      </div>
      <button class="btn btn-primary" onclick="saveProfile()">ğŸ’¾ Saqlash</button>
    </div>

    <!-- Change password -->
    <div class="glass-card" style="margin-bottom:1.25rem">
      <h3 style="font-size:0.95rem;margin-bottom:1.1rem;font-family:'Unbounded',sans-serif">ğŸ” Parolni o'zgartirish</h3>
      <div class="form-group">
        <label class="form-label">Hozirgi parol</label>
        <div class="pwd-wrap">
          <input id="p-cur-pwd" type="password" class="form-input" placeholder="Hozirgi parol"/>
          <button type="button" class="pwd-eye" onclick="tPwd('p-cur-pwd',this)">ğŸ‘ï¸</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Yangi parol</label>
        <div class="pwd-wrap">
          <input id="p-new-pwd" type="password" class="form-input" placeholder="Kamida 6 ta belgi"/>
          <button type="button" class="pwd-eye" onclick="tPwd('p-new-pwd',this)">ğŸ‘ï¸</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Yangi parolni tasdiqlang</label>
        <div class="pwd-wrap">
          <input id="p-conf-pwd" type="password" class="form-input" placeholder="Takrorlang"/>
          <button type="button" class="pwd-eye" onclick="tPwd('p-conf-pwd',this)">ğŸ‘ï¸</button>
        </div>
      </div>
      <button class="btn btn-primary" onclick="changePwd()">ğŸ” Parolni yangilash</button>
    </div>

    <!-- Stats summary -->
    <div class="glass-card">
      <h3 style="font-size:0.95rem;margin-bottom:1.1rem;font-family:'Unbounded',sans-serif">ğŸ“Š Statistika</h3>
      <div class="grid-3">
        <div style="text-align:center">
          <div class="stat-val" id="ps-tests">0</div><div class="stat-lbl">Testlar</div>
        </div>
        <div style="text-align:center">
          <div class="stat-val" id="ps-done">0</div><div class="stat-lbl">Ishlangan</div>
        </div>
        <div style="text-align:center">
          <div class="stat-val" id="ps-avg">â€”</div><div class="stat-lbl">O'rtacha</div>
        </div>
      </div>
    </div>

  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
let currentUser = null;
let userProfile = null;

(async () => {
  currentUser = await AuthHelpers.requireAuth('login.html');
  if (!currentUser) return;
  userProfile = await DB.getUser(currentUser.uid).catch(() => null);

  const name = userProfile?.name || currentUser.displayName || 'Foydalanuvchi';

  // Avatar
  const avaWrap  = document.getElementById('avatar-wrap');
  const avaText  = document.getElementById('avatar-text');
  if (userProfile?.avatarUrl) {
    avaText.innerHTML = `<img src="${userProfile.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`;
  } else {
    avaText.textContent = name[0].toUpperCase();
  }

  document.getElementById('ava').textContent = name[0].toUpperCase();
  document.getElementById('uname').textContent = name;

  // Header
  document.getElementById('profile-name').textContent  = name;
  document.getElementById('profile-email').textContent = currentUser.email || 'â€”';
  document.getElementById('profile-role-badge').innerHTML =
    userProfile?.role === 'admin'
      ? '<span class="badge badge-amber">ğŸ‘‘ Admin</span>'
      : '<span class="badge badge-indigo">ğŸ‘¤ Foydalanuvchi</span>';

  // Form
  document.getElementById('p-name').value  = userProfile?.name || currentUser.displayName || '';
  document.getElementById('p-age').value   = userProfile?.age  || '';
  document.getElementById('p-email').value = currentUser.email || '';

  // Stats
  const [myTests, results] = await Promise.all([
    DB.getTests({ authorId: currentUser.uid }).catch(() => []),
    DB.getResults({ userId: currentUser.uid }).catch(() => []),
  ]);
  document.getElementById('ps-tests').textContent = myTests.length;
  document.getElementById('ps-done').textContent  = results.length;
  if (results.length) {
    const avg = Math.round(results.reduce((s,r) => s+(r.score||0), 0) / results.length);
    document.getElementById('ps-avg').textContent = avg + '%';
  }
})();

window.saveProfile = async function() {
  const name = document.getElementById('p-name').value.trim();
  const age  = +document.getElementById('p-age').value || 0;
  if (!name) { showAlert('Ism kiriting', 'warn'); return; }

  try {
    await currentUser.updateProfile({ displayName: name });
    await DB.updateUser(currentUser.uid, { name, age });
    showAlert('âœ… Profil yangilandi!', 'success');
    document.getElementById('profile-name').textContent = name;
    document.getElementById('ava').textContent = name[0].toUpperCase();
  } catch(e) { showAlert(e.message); }
};

window.changePwd = async function() {
  const cur  = document.getElementById('p-cur-pwd').value;
  const nw   = document.getElementById('p-new-pwd').value;
  const conf = document.getElementById('p-conf-pwd').value;
  if (!cur || !nw) { showAlert('Barcha maydonlarni to\'ldiring', 'warn'); return; }
  if (nw !== conf) { showAlert('Yangi parollar mos kelmadi'); return; }
  if (nw.length < 6) { showAlert('Parol kamida 6 ta belgi bo\'lishi kerak'); return; }

  try {
    const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, cur);
    await currentUser.reauthenticateWithCredential(cred);
    await currentUser.updatePassword(nw);
    showAlert('âœ… Parol yangilandi!', 'success');
    document.getElementById('p-cur-pwd').value = '';
    document.getElementById('p-new-pwd').value = '';
    document.getElementById('p-conf-pwd').value = '';
  } catch(e) {
    const msgs = { 'auth/wrong-password':"Hozirgi parol noto'g'ri" };
    showAlert(msgs[e.code] || e.message);
  }
};

window.uploadAvatar = async function(inp) {
  const file = inp.files[0];
  if (!file) return;

  // Convert to base64 and store in Firestore (no Storage needed)
  const reader = new FileReader();
  reader.onload = async e => {
    const base64 = e.target.result;
    try {
      await DB.updateUser(currentUser.uid, { avatarUrl: base64 });
      const avaText = document.getElementById('avatar-text');
      avaText.innerHTML = `<img src="${base64}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`;
      Toast.success('Rasm saqlandi!');
    } catch(err) { Toast.error(err.message); }
  };
  reader.readAsDataURL(file);
};

function showAlert(msg, type='error') {
  document.getElementById('profile-alert').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => document.getElementById('profile-alert').innerHTML = '', 4000);
}

function tPwd(id, btn) {
  const inp = document.getElementById(id);
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
}
</script>
</body>
</html>
