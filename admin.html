<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro â€” Admin Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
.tab-bar{display:flex;gap:0.35rem;background:var(--bg-2);padding:3px;border-radius:var(--radius-sm);margin-bottom:1.5rem;flex-wrap:wrap}
.t-tab{padding:0.5rem 1rem;font-size:0.82rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:all var(--t);font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-3);background:none;white-space:nowrap}
.t-tab.active{background:var(--bg-card);color:var(--accent);box-shadow:var(--shadow-sm)}
[data-theme="dark"] .t-tab.active{background:var(--bg)}
.tab-pane{display:none}.tab-pane.show{display:block}

.acc{background:var(--bg-card);border:1px solid var(--border-2);border-radius:var(--radius);margin-bottom:0.75rem;overflow:hidden;transition:box-shadow var(--t)}
[data-theme="dark"] .acc{background:var(--bg-2);border-color:var(--border)}
.acc:hover{box-shadow:var(--shadow-sm)}
.acc-hdr{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;cursor:pointer;transition:background var(--t);user-select:none;gap:0.75rem;flex-wrap:wrap}
.acc-hdr:hover{background:rgba(79,70,229,0.04)}
.acc-body{display:none;border-top:1px solid var(--border-2)}
.acc-body.open{display:block}
.acc-chevron{transition:transform 0.3s;color:var(--text-3);font-size:1rem}
.acc-body.open ~ .acc-chevron,.acc-hdr.open .acc-chevron{transform:rotate(90deg)}

.chart-box{height:220px;position:relative}

/* User card in modal */
.info-row{display:flex;justify-content:space-between;padding:0.55rem 0;border-bottom:1px solid var(--border-2);font-size:0.85rem}
.info-row:last-child{border:none}
.info-lbl{color:var(--text-3);font-weight:600}
.info-val{color:var(--text);text-align:right}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-brand" style="background:var(--grad-amber);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">ğŸ‘‘ Admin</div>
  <div style="display:flex;gap:0.6rem;align-items:center">
    <button class="theme-toggle">ğŸŒ™</button>
    <button class="hamburger sidebar-toggle"><span></span><span></span><span></span></button>
  </div>
</div>
<div class="sidebar-overlay"></div>

<aside class="sidebar">
  <div style="padding:1.25rem 1rem 0.5rem;border-bottom:1px solid var(--border)">
    <div style="font-family:'Unbounded',sans-serif;font-size:1.1rem;font-weight:900;background:var(--grad-amber);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">TestPro</div>
    <div style="font-size:0.7rem;color:var(--text-3);margin-top:0.1rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em">Admin Panel</div>
  </div>
  <div class="sidebar-inner">
    <div class="sidebar-section-label">Admin</div>
    <a href="admin.html" class="sidebar-nav-item active">ğŸ“Š Statistika</a>
    <div class="sidebar-section-label" style="margin-top:0.5rem">Sahifalar</div>
    <a href="dashboard.html" class="sidebar-nav-item">ğŸ  Dashboard</a>
    <a href="create.html" class="sidebar-nav-item">âœï¸ Test yaratish</a>
    <a href="index.html" class="sidebar-nav-item">ğŸŒ Bosh sahifa</a>
  </div>
  <div class="sidebar-footer">
    <div class="user-chip">
      <div class="user-ava" id="ava" style="background:var(--grad-amber)">A</div>
      <div style="flex:1;min-width:0">
        <div class="user-chip-name" id="uname">Admin</div>
        <div class="user-chip-role" style="color:#D97706">ğŸ‘‘ Admin</div>
      </div>
      <a href="profile.html" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem">ğŸ‘¤</a>
      <button id="logout-btn" class="btn btn-ghost btn-sm" style="padding:0.3rem 0.5rem">ğŸšª</button>
    </div>
  </div>
</aside>

<main class="main-area">
  <div class="page-hdr" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1.75rem">
    <div><h1>Admin Panel</h1><p>Platforma boshqaruv markazi</p></div>
    <div style="display:flex;gap:0.5rem">
      <span class="badge badge-amber">ğŸ‘‘ Admin</span>
    </div>
  </div>

  <!-- Stats grid -->
  <div class="grid-4" style="margin-bottom:2rem" id="stats-grid">
    <div class="stat-card fade-in"><div class="stat-icon" style="background:rgba(79,70,229,0.1)">ğŸ‘¥</div><div class="stat-val" id="as-users">â€”</div><div class="stat-lbl">Foydalanuvchi</div></div>
    <div class="stat-card fade-in d1"><div class="stat-icon" style="background:rgba(16,185,129,0.1)">ğŸ“</div><div class="stat-val" id="as-tests">â€”</div><div class="stat-lbl">Testlar</div></div>
    <div class="stat-card fade-in d2"><div class="stat-icon" style="background:rgba(245,158,11,0.1)">ğŸ†</div><div class="stat-val" id="as-results">â€”</div><div class="stat-lbl">Urinishlar</div></div>
    <div class="stat-card fade-in d3"><div class="stat-icon" style="background:rgba(6,182,212,0.1)">ğŸ“ˆ</div><div class="stat-val" id="as-avg">â€”</div><div class="stat-lbl">O'rtacha ball</div></div>
  </div>

  <!-- Charts -->
  <div class="grid-2" style="margin-bottom:2rem">
    <div class="glass-card fade-in">
      <h3 style="font-size:0.88rem;font-weight:700;margin-bottom:1rem;color:var(--text-2)">ğŸ“Š 7 kunlik faollik</h3>
      <div class="chart-box"><canvas id="chart-activity"></canvas></div>
    </div>
    <div class="glass-card fade-in d1">
      <h3 style="font-size:0.88rem;font-weight:700;margin-bottom:1rem;color:var(--text-2)">ğŸ¯ Ball taqsimlanishi</h3>
      <div class="chart-box"><canvas id="chart-scores"></canvas></div>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="tab-bar">
    <button class="t-tab active" data-tab="subjects">ğŸ“š Fanlar bo'yicha</button>
    <button class="t-tab" data-tab="users">ğŸ‘¥ Foydalanuvchilar</button>
    <button class="t-tab" data-tab="alltests">ğŸ“ Barcha testlar</button>
    <button class="t-tab" data-tab="results">ğŸ† Natijalar</button>
  </div>

  <!-- Fanlar bo'yicha (accordion) -->
  <div class="tab-pane show" id="tab-subjects">
    <div id="subj-loading" style="text-align:center;padding:2rem"><div class="spinner" style="margin:0 auto"></div></div>
    <div id="subj-accordions"></div>
  </div>

  <!-- Foydalanuvchilar -->
  <div class="tab-pane" id="tab-users">
    <div style="display:flex;gap:0.75rem;margin-bottom:1.25rem;flex-wrap:wrap">
      <div class="search-bar" style="flex:1;min-width:180px">
        <input type="text" class="form-input" id="user-search" placeholder="Qidirish..."/>
      </div>
      <select class="form-input" id="user-role-filter" style="width:140px">
        <option value="all">Barchasi</option>
        <option value="admin">Admin</option>
        <option value="user">Foydalanuvchi</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Ism</th><th>Email</th><th>Rol</th><th>Ro'yxatdan</th><th>Amallar</th></tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="5" style="text-align:center;color:var(--text-3);padding:2rem">Yuklanmoqda...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Barcha testlar -->
  <div class="tab-pane" id="tab-alltests">
    <div style="display:flex;gap:0.75rem;margin-bottom:1.25rem;flex-wrap:wrap">
      <div class="search-bar" style="flex:1;min-width:180px">
        <input type="text" class="form-input" id="test-search" placeholder="Test qidirish..."/>
      </div>
      <select class="form-input" id="test-subj-filter" style="width:160px">
        <option value="all">Barcha fanlar</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Test nomi</th><th>Fan</th><th>Ko'rinish</th><th>Savollar</th><th>Urinish</th><th>Yaratilgan</th><th>Amallar</th></tr>
        </thead>
        <tbody id="tests-tbody">
          <tr><td colspan="7" style="text-align:center;color:var(--text-3);padding:2rem">Yuklanmoqda...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Natijalar -->
  <div class="tab-pane" id="tab-results">
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Test</th><th>Foydalanuvchi</th><th>Ball</th><th>Holat</th><th>Davomiyligi</th><th>Sana</th></tr>
        </thead>
        <tbody id="results-tbody">
          <tr><td colspan="6" style="text-align:center;color:var(--text-3);padding:2rem">Yuklanmoqda...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- User detail modal -->
<div class="modal-overlay" id="user-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title">ğŸ‘¤ Foydalanuvchi ma'lumotlari</span>
      <button class="modal-close">âœ•</button>
    </div>
    <div id="user-modal-body"></div>
  </div>
</div>

<!-- Confirm delete modal -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title" id="confirm-title">Tasdiqlash</span>
      <button class="modal-close">âœ•</button>
    </div>
    <p id="confirm-msg" style="color:var(--text-2);margin-bottom:1.5rem;font-size:0.9rem"></p>
    <div style="display:flex;gap:0.75rem;justify-content:flex-end">
      <button class="btn btn-ghost" data-close-modal>Bekor</button>
      <button class="btn btn-danger" id="confirm-ok">O'chirish</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
let allUsers = [], allTests = [], allResults = [];
let activeCharts = [];

(async () => {
  // Auth check
  const user = await AuthHelpers.requireAuth('login.html');
  if (!user) return;
  const profile = await DB.getUser(user.uid).catch(() => null);
  if (profile?.role !== 'admin') {
    Toast.error('Admin huquqi yo\'q!');
    setTimeout(() => location.href = 'dashboard.html', 1500);
    return;
  }
  document.getElementById('ava').textContent = (profile.name || 'A')[0].toUpperCase();
  document.getElementById('uname').textContent = profile.name || 'Admin';

  // Load all data in parallel
  try {
    [allUsers, allResults] = await Promise.all([
      DB.getAllUsers(500).catch(() => []),
      DB.getResults({ limit: 500 }).catch(() => []),
    ]);
    const testSnap = await db.collection('tests').get();
    allTests = testSnap.docs.map(d => ({ id: d.id, ...d.data() }))
      .sort((a, b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
  } catch(e) { Toast.error('Yuklanmadi: ' + e.message); }

  // Stats
  document.getElementById('as-users').textContent   = allUsers.length;
  document.getElementById('as-tests').textContent   = allTests.length;
  document.getElementById('as-results').textContent = allResults.length;
  if (allResults.length) {
    const avg = Math.round(allResults.reduce((s,r) => s+(r.score||0), 0) / allResults.length);
    document.getElementById('as-avg').textContent = avg + '%';
  }

  buildCharts();
  renderSubjectAccordions();
  renderUsers(allUsers);
  renderAllTests(allTests);
  renderResults(allResults);
  setupFilters();
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildCharts() {
  activeCharts.forEach(c => c.destroy());
  activeCharts = [];
  const dark = document.documentElement.getAttribute('data-theme') === 'dark';
  const tc = dark ? '#9094C0' : '#4B5563';
  const gc = dark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

  // 7-day activity
  const days = [], counts = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    days.push(d.toLocaleDateString('uz-UZ', { weekday:'short' }));
    const s = new Date(d).setHours(0,0,0,0);
    const e = new Date(d).setHours(23,59,59,999);
    counts.push(allResults.filter(r => {
      const t = r.completedAt?.toMillis?.() || (r.completedAt?.seconds||0)*1000;
      return t >= s && t <= e;
    }).length);
  }
  const c1 = new Chart(document.getElementById('chart-activity'), {
    type: 'bar',
    data: { labels: days, datasets: [{ data: counts, backgroundColor: 'rgba(79,70,229,0.7)', borderColor: '#4F46E5', borderWidth: 2, borderRadius: 8, borderSkipped: false }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
      scales: { x: { ticks: { color: tc, font: { size: 11 } }, grid: { color: gc } }, y: { ticks: { color: tc, stepSize: 1, font: { size: 11 } }, grid: { color: gc }, beginAtZero: true } } }
  });
  activeCharts.push(c1);

  // Score distribution
  const bins = [0, 0, 0, 0];
  allResults.forEach(r => {
    const s = r.score || 0;
    if (s < 50) bins[0]++; else if (s < 70) bins[1]++; else if (s < 85) bins[2]++; else bins[3]++;
  });
  const c2 = new Chart(document.getElementById('chart-scores'), {
    type: 'doughnut',
    data: { labels: ['0â€“49%', '50â€“69%', '70â€“84%', '85â€“100%'], datasets: [{ data: bins, backgroundColor: ['rgba(244,63,94,0.75)', 'rgba(245,158,11,0.75)', 'rgba(6,182,212,0.75)', 'rgba(16,185,129,0.75)'], borderWidth: 3, hoverOffset: 10 }] },
    options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: tc, font: { size: 11 }, padding: 12, usePointStyle: true } } } }
  });
  activeCharts.push(c2);
}
window.addEventListener('themeChanged', () => setTimeout(buildCharts, 100));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUBJECT ACCORDIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSubjectAccordions() {
  document.getElementById('subj-loading').style.display = 'none';
  const wrap = document.getElementById('subj-accordions');
  wrap.innerHTML = '';

  const groups = {};
  allTests.forEach(t => {
    const s = t.subject || 'other';
    if (!groups[s]) groups[s] = [];
    groups[s].push(t);
  });

  if (!Object.keys(groups).length) {
    wrap.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“­</div><h3>Test mavjud emas</h3></div>';
    return;
  }

  // Sort by count desc
  const sorted = Object.entries(groups).sort((a, b) => b[1].length - a[1].length);

  sorted.forEach(([subj, tests]) => {
    const sub = getSubject(subj);
    const totalAttempts = tests.reduce((s, t) => s + (t.attempts||0), 0);

    const acc = document.createElement('div');
    acc.className = 'acc fade-in';
    acc.innerHTML = `
      <div class="acc-hdr" onclick="toggleAcc(this)">
        <div style="display:flex;align-items:center;gap:0.85rem;flex:1;min-width:0">
          <div class="subject-icon ${sub.cls}" style="background:var(--subj-bg,rgba(79,70,229,0.1));width:44px;height:44px;flex-shrink:0">
            ${sub.emoji}
          </div>
          <div style="min-width:0">
            <div style="font-weight:800;font-size:0.95rem;font-family:'Unbounded',sans-serif;letter-spacing:-0.03em">${esc(sub.label)}</div>
            <div style="font-size:0.75rem;color:var(--text-3);margin-top:0.1rem">
              ${tests.length} test Â· ${totalAttempts} urinish
            </div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.65rem;flex-shrink:0">
          <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();confirmDeleteSubject('${subj}', '${esc(sub.label)}')" data-tip="Barchasini o'chirish">
            ğŸ—‘ï¸ Hammasini o'chirish
          </button>
          <span class="acc-chevron">â€º</span>
        </div>
      </div>
      <div class="acc-body">
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr><th>Test nomi</th><th>Ko'rinish</th><th>Savollar</th><th>Urinish</th><th>O'rtacha</th><th>Amallar</th></tr>
            </thead>
            <tbody>
              ${tests.map(t => `
                <tr>
                  <td>
                    <div style="font-weight:600;font-size:0.875rem">${esc(t.title)}</div>
                    <div style="font-size:0.72rem;color:var(--text-3)">${fmtDate(t.createdAt)}</div>
                  </td>
                  <td>${visBadge(t.visibility, t.accessCode)}</td>
                  <td><span class="badge badge-indigo">${t.questionCount||0}</span></td>
                  <td>${t.attempts||0}</td>
                  <td>${t.averageScore ? t.averageScore+'%' : 'â€”'}</td>
                  <td>
                    <div style="display:flex;gap:0.35rem">
                      <a href="test.html?id=${t.id}" class="btn btn-secondary btn-sm" data-tip="Ko'rish">â–¶ï¸</a>
                      <a href="create.html?id=${t.id}" class="btn btn-ghost btn-sm" data-tip="Tahrirlash">âœï¸</a>
                      <button class="btn btn-danger btn-sm" onclick="confirmDelTest('${t.id}','${esc(t.title)}')" data-tip="O'chirish">ğŸ—‘ï¸</button>
                    </div>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
    wrap.appendChild(acc);
  });
}

window.toggleAcc = function(hdr) {
  const body = hdr.nextElementSibling;
  const isOpen = body.classList.toggle('open');
  hdr.querySelector('.acc-chevron').style.transform = isOpen ? 'rotate(90deg)' : '';
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• USERS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderUsers(users) {
  const tbody = document.getElementById('users-tbody');
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty" style="text-align:center;padding:2rem;color:var(--text-3)">Foydalanuvchi topilmadi</td></tr>';
    return;
  }
  tbody.innerHTML = users.map(u => `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:0.65rem">
          <div style="width:32px;height:32px;border-radius:50%;background:var(--grad-main);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:0.78rem;flex-shrink:0;font-family:'Unbounded',sans-serif">
            ${(u.name||'U')[0].toUpperCase()}
          </div>
          <div>
            <div style="font-weight:600;font-size:0.875rem">${esc(u.name||'â€”')}</div>
            ${u.age ? `<div style="font-size:0.72rem;color:var(--text-3)">${u.age} yosh</div>` : ''}
          </div>
        </div>
      </td>
      <td style="font-size:0.82rem;color:var(--text-2)">${esc(u.email||'â€”')}</td>
      <td>
        ${u.role === 'admin'
          ? '<span class="badge badge-amber">ğŸ‘‘ Admin</span>'
          : '<span class="badge badge-indigo">ğŸ‘¤ User</span>'}
      </td>
      <td style="font-size:0.8rem;color:var(--text-3)">${fmtDate(u.createdAt)}</td>
      <td>
        <div style="display:flex;gap:0.35rem;flex-wrap:wrap">
          <button class="btn btn-secondary btn-sm" onclick="viewUser('${u.id}')">ğŸ‘ï¸</button>
          ${u.role !== 'admin'
            ? `<button class="btn btn-ghost btn-sm" onclick="promoteUser('${u.id}','${esc(u.name||'')}')">ğŸ‘‘ Admin</button>`
            : `<button class="btn btn-ghost btn-sm" onclick="demoteUser('${u.id}','${esc(u.name||'')}')">â¬‡ï¸ User</button>`}
          <button class="btn btn-danger btn-sm" onclick="confirmDelUser('${u.id}','${esc(u.name||'')}')">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALL TESTS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAllTests(tests) {
  const tbody = document.getElementById('tests-tbody');
  if (!tests.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-3)">Test topilmadi</td></tr>';
    return;
  }
  tbody.innerHTML = tests.map(t => {
    const sub = getSubject(t.subject);
    return `
      <tr>
        <td>
          <div style="font-weight:600;font-size:0.875rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title)}</div>
        </td>
        <td><span class="subj-badge ${sub.cls}">${sub.emoji} ${esc(sub.label)}</span></td>
        <td>${visBadge(t.visibility, t.accessCode)}</td>
        <td><span class="badge badge-indigo">${t.questionCount||0}</span></td>
        <td>${t.attempts||0}</td>
        <td style="font-size:0.78rem;color:var(--text-3)">${fmtDate(t.createdAt)}</td>
        <td>
          <div style="display:flex;gap:0.35rem">
            <a href="test.html?id=${t.id}" class="btn btn-secondary btn-sm">â–¶ï¸</a>
            <a href="create.html?id=${t.id}" class="btn btn-ghost btn-sm">âœï¸</a>
            <button class="btn btn-danger btn-sm" onclick="confirmDelTest('${t.id}','${esc(t.title)}')">ğŸ—‘ï¸</button>
          </div>
        </td>
      </tr>`;
  }).join('');

  // Populate subject filter
  const sel = document.getElementById('test-subj-filter');
  const subjects = [...new Set(allTests.map(t => t.subject).filter(Boolean))];
  subjects.forEach(s => {
    const sub = getSubject(s);
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = `${sub.emoji} ${sub.label}`;
    sel.appendChild(opt);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResults(results) {
  const tbody = document.getElementById('results-tbody');
  if (!results.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-3)">Natija topilmadi</td></tr>';
    return;
  }
  tbody.innerHTML = results.slice(0, 100).map(r => {
    const sc = r.score >= 80 ? 'score-high' : r.score >= 50 ? 'score-mid' : 'score-low';
    return `
      <tr>
        <td style="font-size:0.875rem;font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.testTitle||'â€”')}</td>
        <td style="font-size:0.8rem;color:var(--text-2)">${esc(r.userId?.slice(0,8)||'â€”')}...</td>
        <td><span class="score-pill ${sc}" style="font-size:0.78rem;padding:0.2rem 0.65rem">${r.score||0}%</span></td>
        <td><span class="badge ${r.passed ? 'badge-green':'badge-rose'}">${r.passed ? 'âœ“ O\'tdi':'âœ— O\'tmadi'}</span></td>
        <td style="font-size:0.8rem;color:var(--text-3)">${fmtTime(r.duration||0)}</td>
        <td style="font-size:0.78rem;color:var(--text-3)">${fmtDate(r.completedAt)}</td>
      </tr>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• FILTERS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupFilters() {
  // User search
  document.getElementById('user-search').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    const role = document.getElementById('user-role-filter').value;
    let filtered = allUsers.filter(u =>
      (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q)
    );
    if (role !== 'all') filtered = filtered.filter(u => u.role === role);
    renderUsers(filtered);
  });
  document.getElementById('user-role-filter').addEventListener('change', e => {
    const q = document.getElementById('user-search').value.toLowerCase();
    const role = e.target.value;
    let filtered = allUsers.filter(u => (u.name||'').toLowerCase().includes(q));
    if (role !== 'all') filtered = filtered.filter(u => u.role === role);
    renderUsers(filtered);
  });

  // Test search
  document.getElementById('test-search').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    const subj = document.getElementById('test-subj-filter').value;
    let filtered = allTests.filter(t => (t.title||'').toLowerCase().includes(q));
    if (subj !== 'all') filtered = filtered.filter(t => t.subject === subj);
    renderAllTests(filtered);
  });
  document.getElementById('test-subj-filter').addEventListener('change', e => {
    const q = document.getElementById('test-search').value.toLowerCase();
    const subj = e.target.value;
    let filtered = allTests.filter(t => (t.title||'').toLowerCase().includes(q));
    if (subj !== 'all') filtered = filtered.filter(t => t.subject === subj);
    renderAllTests(filtered);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB SWITCHING â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.t-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.t-tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('show');
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• USER ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.viewUser = async function(uid) {
  Modal.open('user-modal');
  document.getElementById('user-modal-body').innerHTML = '<div style="text-align:center;padding:1.5rem"><div class="spinner" style="margin:0 auto"></div></div>';
  try {
    const u = allUsers.find(x => x.id === uid);
    if (!u) { document.getElementById('user-modal-body').innerHTML = '<p>Topilmadi</p>'; return; }

    const [myTests, results] = await Promise.all([
      DB.getTests({ authorId: uid }).catch(() => []),
      DB.getResults({ userId: uid, limit: 10 }).catch(() => []),
    ]);
    const avg = results.length ? Math.round(results.reduce((s,r)=>s+(r.score||0),0)/results.length) : null;

    document.getElementById('user-modal-body').innerHTML = `
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
        <div style="width:56px;height:56px;border-radius:50%;background:var(--grad-main);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.4rem;font-weight:900;font-family:'Unbounded',sans-serif;flex-shrink:0">
          ${(u.name||'U')[0].toUpperCase()}
        </div>
        <div>
          <div style="font-weight:800;font-size:1rem">${esc(u.name||'â€”')}</div>
          <div style="font-size:0.8rem;color:var(--text-3)">${esc(u.email||'â€”')}</div>
          <div style="margin-top:0.25rem">${u.role==='admin'?'<span class="badge badge-amber">ğŸ‘‘ Admin</span>':'<span class="badge badge-indigo">ğŸ‘¤ User</span>'}</div>
        </div>
      </div>
      <div>
        <div class="info-row"><span class="info-lbl">Yosh</span><span class="info-val">${u.age||'â€”'}</span></div>
        <div class="info-row"><span class="info-lbl">Testlar</span><span class="info-val">${myTests.length}</span></div>
        <div class="info-row"><span class="info-lbl">Ishlangan</span><span class="info-val">${results.length}</span></div>
        <div class="info-row"><span class="info-lbl">O'rtacha ball</span><span class="info-val">${avg !== null ? avg+'%' : 'â€”'}</span></div>
        <div class="info-row"><span class="info-lbl">Ro'yxatdan</span><span class="info-val">${fmtDate(u.createdAt)}</span></div>
      </div>
      <div style="display:flex;gap:0.65rem;margin-top:1.5rem;flex-wrap:wrap">
        ${u.role !== 'admin'
          ? `<button class="btn btn-secondary btn-sm" onclick="promoteUser('${u.id}','${esc(u.name||'')}');Modal.close('user-modal')">ğŸ‘‘ Admin qilish</button>`
          : `<button class="btn btn-secondary btn-sm" onclick="demoteUser('${u.id}','${esc(u.name||'')}');Modal.close('user-modal')">â¬‡ï¸ User qilish</button>`}
        <button class="btn btn-danger btn-sm" onclick="confirmDelUser('${u.id}','${esc(u.name||'')}');Modal.close('user-modal')">ğŸ—‘ï¸ O'chirish</button>
      </div>`;
  } catch(e) {
    document.getElementById('user-modal-body').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
  }
};

window.promoteUser = async function(uid, name) {
  if (!confirm(`"${name}" ni admin qilasizmi?`)) return;
  try {
    await DB.updateUser(uid, { role: 'admin' });
    allUsers = allUsers.map(u => u.id === uid ? { ...u, role: 'admin' } : u);
    renderUsers(allUsers);
    Toast.success(`âœ… ${name} endi admin!`);
  } catch(e) { Toast.error(e.message); }
};

window.demoteUser = async function(uid, name) {
  if (!confirm(`"${name}" ni oddiy user qilasizmi?`)) return;
  try {
    await DB.updateUser(uid, { role: 'user' });
    allUsers = allUsers.map(u => u.id === uid ? { ...u, role: 'user' } : u);
    renderUsers(allUsers);
    Toast.success(`âœ… ${name} roli o'zgartirildi`);
  } catch(e) { Toast.error(e.message); }
};

function confirmDelUser(uid, name) {
  document.getElementById('confirm-title').textContent = 'Foydalanuvchini o\'chirish';
  document.getElementById('confirm-msg').textContent = `"${name}" foydalanuvchisini o'chirishni tasdiqlaysizmi?`;
  document.getElementById('confirm-ok').onclick = async () => {
    try {
      await db.collection('users').doc(uid).delete();
      allUsers = allUsers.filter(u => u.id !== uid);
      renderUsers(allUsers);
      Modal.close('confirm-modal');
      Toast.success('Foydalanuvchi o\'chirildi');
    } catch(e) { Toast.error(e.message); }
  };
  Modal.open('confirm-modal');
}
window.confirmDelUser = confirmDelUser;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• TEST DELETE â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function confirmDelTest(testId, title) {
  document.getElementById('confirm-title').textContent = 'Testni o\'chirish';
  document.getElementById('confirm-msg').textContent = `"${title}" testini o'chirishni tasdiqlaysizmi? Bu amalni qaytarib bo'lmaydi.`;
  document.getElementById('confirm-ok').onclick = async () => {
    try {
      await DB.deleteTest(testId);
      allTests = allTests.filter(t => t.id !== testId);
      renderSubjectAccordions();
      renderAllTests(allTests);
      Modal.close('confirm-modal');
      Toast.success('Test o\'chirildi');
      document.getElementById('as-tests').textContent = allTests.length;
    } catch(e) { Toast.error(e.message); }
  };
  Modal.open('confirm-modal');
}
window.confirmDelTest = confirmDelTest;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUBJECT DELETE â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function confirmDeleteSubject(subj, label) {
  const tests = allTests.filter(t => (t.subject||'other') === subj);
  document.getElementById('confirm-title').textContent = `"${label}" fanini o'chirish`;
  document.getElementById('confirm-msg').textContent = `Bu fan ostidagi ${tests.length} ta test ham o'chiriladi. Tasdiqlaysizmi?`;
  document.getElementById('confirm-ok').onclick = async () => {
    try {
      await Promise.all(tests.map(t => DB.deleteTest(t.id)));
      allTests = allTests.filter(t => (t.subject||'other') !== subj);
      renderSubjectAccordions();
      renderAllTests(allTests);
      Modal.close('confirm-modal');
      Toast.success(`${tests.length} ta test o'chirildi!`);
      document.getElementById('as-tests').textContent = allTests.length;
    } catch(e) { Toast.error(e.message); }
  };
  Modal.open('confirm-modal');
}
window.confirmDeleteSubject = confirmDeleteSubject;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function visBadge(vis, code) {
  if (vis === 'public')  return '<span class="badge badge-green">ğŸŒ Ommaviy</span>';
  if (vis === 'code')    return `<span class="badge badge-amber">ğŸ”‘ ${code||'Kodli'}</span>`;
  return '<span class="badge badge-gray">ğŸ”’ Shaxsiy</span>';
}
</script>
</body>
</html>
