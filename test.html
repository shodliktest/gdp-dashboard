<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro ‚Äî Test</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
<style>
.test-topbar{position:sticky;top:0;z-index:100;background:var(--navbar-bg);backdrop-filter:blur(20px);border-bottom:1px solid var(--border-2);padding:0.85rem 1.5rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.test-title-txt{font-size:0.9rem;font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.timer{display:flex;align-items:center;gap:0.4rem;padding:0.35rem 0.85rem;border-radius:99px;background:rgba(79,70,229,0.08);border:1px solid rgba(79,70,229,0.2);color:var(--accent);font-family:'Unbounded',sans-serif;font-weight:800;font-size:0.85rem}
.timer.warn{background:rgba(244,63,94,0.1);border-color:rgba(244,63,94,0.3);color:#E11D48;animation:pulse 1s infinite}
.prog-strip{height:3px;background:var(--border-2)}
.prog-strip-fill{height:100%;background:var(--grad-main);transition:width 0.4s var(--ease-out)}
.test-body{max-width:720px;margin:0 auto;padding:2rem 1.25rem}
.q-dot-wrap{display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1.5rem}
.q-dot{width:30px;height:30px;border-radius:50%;border:2px solid var(--border-2);background:var(--bg-2);font-size:0.72rem;font-weight:800;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--t);font-family:'Unbounded',sans-serif;color:var(--text-3)}
.q-dot:hover{border-color:var(--accent)}
.q-dot.answered{background:var(--accent);border-color:var(--accent);color:#fff}
.q-dot.current{border-color:var(--accent);color:var(--accent)}
.q-panel{background:var(--bg-card);border:1px solid var(--border-2);border-radius:var(--radius-lg);padding:1.75rem;margin-bottom:1.25rem;animation:fadeInUp 0.3s var(--ease-out)}
[data-theme="dark"] .q-panel{background:var(--bg-2);border-color:var(--border)}
.q-panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.1rem}
.q-label{font-size:0.75rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em}
.q-pts{font-size:0.75rem;color:var(--text-3)}
.q-text-disp{font-size:1rem;font-weight:600;line-height:1.6;margin-bottom:1.4rem;color:var(--text)}
.opt-btn{
  width:100%;text-align:left;padding:0.9rem 1.1rem;
  border:2px solid var(--border-2);border-radius:var(--radius-sm);
  background:var(--bg-2);color:var(--text);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;
  cursor:pointer;transition:all var(--t);display:flex;align-items:center;gap:0.85rem;
  margin-bottom:0.55rem;
}
[data-theme="dark"] .opt-btn{background:var(--bg);border-color:var(--border)}
.opt-btn:hover{border-color:var(--accent);background:rgba(79,70,229,0.05);transform:translateX(4px)}
.opt-btn.sel{border-color:var(--accent);background:rgba(79,70,229,0.08);color:var(--accent)}
.opt-btn.correct{border-color:#059669;background:rgba(16,185,129,0.08);color:#059669}
.opt-btn.wrong{border-color:#E11D48;background:rgba(244,63,94,0.07);color:#E11D48}
.opt-btn.disabled{pointer-events:none}
.opt-letter{width:26px;height:26px;border-radius:50%;background:var(--border-2);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.75rem;flex-shrink:0;font-family:'Unbounded',sans-serif}
.opt-btn.sel .opt-letter{background:var(--accent);color:#fff}
.opt-btn.correct .opt-letter{background:#059669;color:#fff}
.opt-btn.wrong .opt-letter{background:#E11D48;color:#fff}
.nav-row{display:flex;gap:0.75rem;justify-content:space-between;flex-wrap:wrap;margin-top:1.25rem}

/* Result */
.result-wrap{max-width:620px;margin:0 auto;padding:2rem 1.25rem;text-align:center}
.result-big{font-family:'Unbounded',sans-serif;font-size:3.5rem;font-weight:900;margin:1rem 0 0.25rem}
.result-card{background:var(--bg-card);border:1px solid var(--border-2);border-radius:var(--radius-lg);padding:2rem;margin-bottom:1.5rem}
[data-theme="dark"] .result-card{background:var(--bg-2);border-color:var(--border)}
.review-q{background:var(--bg-card);border:1px solid var(--border-2);border-radius:var(--radius);padding:1.25rem;margin-bottom:0.85rem;text-align:left}
[data-theme="dark"] .review-q{background:var(--bg-2);border-color:var(--border)}
.expl-box{margin-top:0.75rem;padding:0.85rem;background:rgba(79,70,229,0.06);border:1px solid rgba(79,70,229,0.15);border-radius:var(--radius-xs);font-size:0.82rem;color:var(--text-2);line-height:1.6}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem">
  <div class="spinner" style="width:48px;height:48px"></div>
  <p style="color:var(--text-3)">Test yuklanmoqda...</p>
</div>

<!-- Test UI -->
<div id="test-ui" style="display:none">
  <div class="prog-strip"><div class="prog-strip-fill" id="prog-fill" style="width:0%"></div></div>
  <div class="test-topbar">
    <div class="test-title-txt" id="t-title">TestPro</div>
    <div class="timer" id="timer" style="display:none">‚è±Ô∏è 00:00</div>
    <button class="theme-toggle">üåô</button>
    <button class="btn btn-danger btn-sm" id="finish-early-btn" onclick="finish(false)" style="display:none">Yakunlash</button>
  </div>

  <div class="test-body">
    <div class="q-dot-wrap" id="q-dots"></div>
    <div id="q-area"></div>
    <div class="nav-row">
      <button class="btn btn-secondary" id="prev-btn" onclick="nav(-1)" style="display:none">‚Üê Oldingi</button>
      <div style="flex:1"></div>
      <button class="btn btn-primary" id="next-btn" onclick="nav(1)">Keyingi ‚Üí</button>
      <button class="btn btn-success" id="submit-btn" onclick="finish(false)" style="display:none">‚úÖ Yakunlash</button>
    </div>
  </div>
</div>

<!-- Result -->
<div id="result-ui" style="display:none">
  <div style="background:var(--navbar-bg);backdrop-filter:blur(20px);border-bottom:1px solid var(--border-2);padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem">
    <div style="font-family:'Unbounded',sans-serif;font-size:1rem;font-weight:900;background:var(--grad-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">TestPro</div>
    <div style="flex:1"></div>
    <button class="theme-toggle">üåô</button>
  </div>
  <div class="result-wrap">
    <div id="result-score-circle"></div>
    <div class="result-big" id="res-pct">0%</div>
    <h2 id="res-title" style="font-size:1.3rem;margin-bottom:0.35rem"></h2>
    <p id="res-sub" style="color:var(--text-2);margin-bottom:1.75rem;font-size:0.9rem"></p>

    <div class="result-card">
      <div class="grid-3" style="gap:0.85rem">
        <div><div class="stat-val" id="res-correct" style="font-size:1.5rem">0</div><div class="stat-lbl">To'g'ri</div></div>
        <div><div class="stat-val" id="res-wrong" style="font-size:1.5rem">0</div><div class="stat-lbl">Noto'g'ri</div></div>
        <div><div class="stat-val" id="res-time" style="font-size:1.5rem">0:00</div><div class="stat-lbl">Vaqt</div></div>
      </div>
    </div>

    <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;margin-bottom:2rem">
      <a href="dashboard.html" class="btn btn-secondary">üè† Dashboard</a>
      <button class="btn btn-primary" id="review-btn">üìã Tahlil</button>
    </div>

    <!-- Review -->
    <div id="review-section" style="display:none;text-align:left">
      <h3 style="margin-bottom:1.25rem;font-size:1rem">Javoblar tahlili</h3>
      <div id="review-list"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
let testDoc = null, questions = [], answers = {}, curIdx = 0;
let startTime, timerInterval, timeLeft, currentUser = null, finished = false;
const params = new URLSearchParams(location.search);
const testId = params.get('id');

(async () => {
  currentUser = await AuthHelpers.getCurrentUser();
  if (!testId) { showErr('Test ID topilmadi'); return; }
  try {
    [testDoc, questions] = await Promise.all([DB.getTest(testId), DB.getQuestions(testId)]);
    if (!testDoc) { showErr('Test topilmadi'); return; }
    if (testDoc.visibility === 'private' && (!currentUser || currentUser.uid !== testDoc.authorId)) {
      showErr('Bu test shaxsiy. Kirish ruxsati yo\'q.'); return;
    }
    if (testDoc.visibility === 'code') {
      const unlocked = JSON.parse(localStorage.getItem('tp_unlocked') || '[]');
      if (!unlocked.includes(testId) && (!currentUser || currentUser.uid !== testDoc.authorId)) {
        showErr('Bu test kodli. Dashboarddan kod kiriting.'); return;
      }
    }
    if (testDoc.shuffleQuestions) questions = questions.sort(() => Math.random() - 0.5);
    initTest();
  } catch(e) { showErr(e.message); }
})();

function initTest() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('test-ui').style.display = 'block';
  document.getElementById('t-title').textContent = testDoc.title;
  document.title = 'TestPro ‚Äî ' + testDoc.title;
  startTime = Date.now();
  if (testDoc.timeLimit > 0) {
    timeLeft = testDoc.timeLimit * 60;
    document.getElementById('timer').style.display = 'flex';
    document.getElementById('finish-early-btn').style.display = 'inline-flex';
    timerInterval = setInterval(() => {
      timeLeft--;
      const el = document.getElementById('timer');
      el.innerHTML = `‚è±Ô∏è ${fmtTime(timeLeft)}`;
      el.classList.toggle('warn', timeLeft < 60);
      if (timeLeft <= 0) { clearInterval(timerInterval); finish(true); }
    }, 1000);
  }
  renderDots(); renderQ();
}

function renderDots() {
  document.getElementById('q-dots').innerHTML = questions.map((q, i) => `
    <div class="q-dot ${answers[q.id]!==undefined?'answered':''} ${i===curIdx?'current':''}"
      onclick="gotoQ(${i})">${i+1}</div>
  `).join('');
  const pct = (Object.keys(answers).length / questions.length) * 100;
  document.getElementById('prog-fill').style.width = pct + '%';
}

function renderQ() {
  const q = questions[curIdx];
  const isAnswered = answers[q.id] !== undefined;
  document.getElementById('q-area').innerHTML = `
    <div class="q-panel">
      <div class="q-panel-head">
        <span class="q-label">Savol ${curIdx+1} / ${questions.length}</span>
        <span class="q-pts">${q.points||1} ball</span>
      </div>
      <div class="q-text-disp">${esc(q.text)}</div>
      <div id="opts-area">
        ${buildOpts(q)}
      </div>
    </div>`;

  document.getElementById('prev-btn').style.display   = curIdx > 0 ? 'inline-flex' : 'none';
  document.getElementById('next-btn').style.display   = curIdx < questions.length-1 ? 'inline-flex' : 'none';
  document.getElementById('submit-btn').style.display = curIdx === questions.length-1 ? 'inline-flex' : 'none';
}

function buildOpts(q) {
  if (q.type === 'text') {
    return `<textarea class="form-input" style="min-height:80px" placeholder="Javobingizni yozing..."
      oninput="saveAns('${q.id}',this.value)">${esc(answers[q.id]||'')}</textarea>`;
  }
  return q.options.map((o, i) => {
    const sel = answers[q.id] === i;
    return `<button class="opt-btn ${sel?'sel':''}" onclick="pickOpt('${q.id}',${i})">
      <span class="opt-letter">${String.fromCharCode(65+i)}</span>${esc(o)}
    </button>`;
  }).join('');
}

window.pickOpt = function(qid, idx) {
  answers[qid] = idx;
  renderDots(); renderQ();
  if (curIdx < questions.length-1) setTimeout(() => nav(1), 350);
};
window.saveAns = function(qid, val) { answers[qid] = val; renderDots(); };
window.nav = function(d) { curIdx = Math.max(0, Math.min(questions.length-1, curIdx+d)); renderDots(); renderQ(); };
window.gotoQ = function(i) { curIdx = i; renderDots(); renderQ(); };

/* ‚îÄ‚îÄ Finish ‚îÄ‚îÄ */
window.finish = async function(timeUp) {
  if (finished) return;
  const unanswered = questions.length - Object.keys(answers).length;
  if (!timeUp && unanswered > 0) {
    if (!confirm(`Hali ${unanswered} savol javobsiz. Yakunlaysizmi?`)) return;
  }
  finished = true;
  clearInterval(timerInterval);
  const dur = Math.round((Date.now() - startTime) / 1000);

  let correct = 0, total = questions.filter(q => q.type !== 'text').length;
  questions.forEach(q => {
    if (q.type === 'text') return;
    if (answers[q.id] === q.correct) correct++;
  });
  const score = total > 0 ? Math.round((correct / total) * 100) : 0;
  const passed = score >= (testDoc.passScore || 60);

  if (currentUser) {
    try {
      await DB.saveResult({
        testId, testTitle: testDoc.title, userId: currentUser.uid,
        score, correct, total: questions.length, duration: dur, passed,
        answers: Object.fromEntries(Object.entries(answers).map(([k,v]) => [k, v])),
      });
    } catch(e) { console.warn(e); }
  }

  if (testDoc.showResult !== false) showResult(score, correct, total, passed, dur);
  else location.href = 'dashboard.html';
};

function showResult(score, correct, wrong_cnt, passed, dur) {
  document.getElementById('test-ui').style.display = 'none';
  document.getElementById('result-ui').style.display = 'block';

  const el = document.getElementById('result-score-circle');
  el.className = `score-circle ${passed?'pass':'fail'}`;
  el.style.cssText = 'width:120px;height:120px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 0.5rem;font-family:"Unbounded",sans-serif;' +
    (passed ? 'border:4px solid #059669;background:rgba(16,185,129,0.08);color:#059669' : 'border:4px solid #E11D48;background:rgba(244,63,94,0.08);color:#E11D48');
  el.innerHTML = `<div style="font-size:2rem;font-weight:900;line-height:1">${score}%</div><div style="font-size:0.6rem;letter-spacing:0.05em;font-family:'Plus Jakarta Sans',sans-serif">Natija</div>`;

  document.getElementById('res-pct').textContent   = '';
  document.getElementById('res-title').textContent = passed ? "üéâ A'lo natija!" : "üòî Muvaffaqiyatsiz";
  document.getElementById('res-sub').textContent   = passed
    ? `O'tish bali: ${testDoc.passScore||60}% ‚Äî siz qabul qildingiz!`
    : `O'tish bali: ${testDoc.passScore||60}% ‚Äî yana bir bor urinib ko'ring`;
  document.getElementById('res-correct').textContent = correct;
  document.getElementById('res-wrong').textContent   = questions.filter(q=>q.type!=='text').length - correct;
  document.getElementById('res-time').textContent    = fmtTime(dur);

  document.getElementById('review-btn').addEventListener('click', () => {
    const sec = document.getElementById('review-section');
    if (sec.style.display === 'none') { sec.style.display = 'block'; buildReview(); }
    else sec.style.display = 'none';
  });
}

function buildReview() {
  const list = document.getElementById('review-list');
  list.innerHTML = questions.map((q, i) => {
    const userAns = answers[q.id];
    const isCorr  = q.type !== 'text' && userAns === q.correct;
    const badge   = q.type === 'text' ? `<span class="badge badge-teal">üìù Matn</span>` :
                    isCorr ? `<span class="badge badge-green">‚úì To'g'ri</span>` :
                             `<span class="badge badge-rose">‚úó Noto'g'ri</span>`;

    const optsHtml = q.type === 'text'
      ? `<div class="form-input" style="min-height:50px;margin-top:0.5rem;pointer-events:none">${esc(userAns||'(Javob berilmadi)')}</div>`
      : q.options.map((o, j) => {
          const cls = j === q.correct ? 'correct' : (j === userAns && j !== q.correct ? 'wrong' : '');
          return `<div class="opt-btn ${cls} disabled">
            <span class="opt-letter">${String.fromCharCode(65+j)}</span>${esc(o)}
            ${j === q.correct ? ' ‚úì' : ''}
          </div>`;
        }).join('');

    const explHtml = q.explanation
      ? `<div class="expl-box">üí° <strong>Izoh:</strong> ${esc(q.explanation)}</div>` : '';

    return `<div class="review-q fade-in">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;margin-bottom:0.75rem">
        <div style="font-size:0.85rem;font-weight:600">${i+1}. ${esc(q.text)}</div>
        ${badge}
      </div>
      ${optsHtml}
      ${explHtml}
    </div>`;
  }).join('');
}

function showErr(msg) {
  document.getElementById('loading-screen').innerHTML = `<div class="empty"><div class="empty-icon">‚ùå</div><h3>${msg}</h3><a href="dashboard.html" class="btn btn-primary" style="margin-top:1rem">Dashboard ‚Üí</a></div>`;
}
</script>
</body>
</html>
