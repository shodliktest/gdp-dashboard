<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TestPro ‚Äî Kirish</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Unbounded:wght@700;800;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="css/style.css"/>
<style>
body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
.auth-wrap{width:100%;max-width:440px}
.auth-logo{font-family:'Unbounded',sans-serif;font-size:1.6rem;font-weight:900;background:var(--grad-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;margin-bottom:2rem;display:block}
.auth-card{background:var(--bg-card);border:1px solid var(--border-2);border-radius:var(--radius-lg);padding:2rem;box-shadow:var(--shadow)}
[data-theme="dark"] .auth-card{background:var(--bg-2);border-color:var(--border)}
.auth-tabs{display:flex;gap:0;background:var(--bg-2);border-radius:var(--radius-sm);padding:3px;margin-bottom:1.75rem}
.auth-tab{flex:1;text-align:center;padding:0.6rem;font-size:0.85rem;font-weight:600;color:var(--text-3);border-radius:8px;cursor:pointer;transition:all var(--t);border:none;background:none;font-family:'Plus Jakarta Sans',sans-serif}
.auth-tab.active{background:var(--bg-card);color:var(--accent);box-shadow:var(--shadow-sm)}
[data-theme="dark"] .auth-tab.active{background:var(--bg)}
.auth-divider{display:flex;align-items:center;gap:0.85rem;margin:1.25rem 0;color:var(--text-3);font-size:0.78rem}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border-2)}
.pwd-wrap{position:relative}
.pwd-wrap .form-input{padding-right:3rem}
.pwd-eye{position:absolute;right:0.85rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-3);font-size:1rem;line-height:1;padding:0.2rem}
.google-btn{width:100%;justify-content:center;gap:0.75rem;padding:0.78rem}
.g-icon{width:20px;height:20px;background:linear-gradient(135deg,#4285F4 0%,#34A853 40%,#FBBC05 70%,#EA4335 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.65rem;font-weight:900;flex-shrink:0}
.theme-pill{position:fixed;top:1.25rem;right:1.25rem}
</style>
</head>
<body id="auth-page">
<div class="theme-pill"><button class="theme-toggle">üåô</button></div>

<div class="auth-wrap fade-in-up">
  <a onclick="goTo('index.html');return false" href="#" class="auth-logo">TestPro</a>

  <div class="auth-card">
    <div style="text-align:center;margin-bottom:1.75rem">
      <h2 id="auth-h" style="font-size:1.4rem;margin-bottom:0.3rem">Xush kelibsiz!</h2>
      <p id="auth-sub" style="font-size:0.85rem;color:var(--text-2)">Hisobingizga kiring</p>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-in">Kirish</button>
      <button class="auth-tab" id="tab-up">Ro'yxatdan o'tish</button>
    </div>

    <div id="auth-alert"></div>

    <!-- LOGIN -->
    <form id="form-login">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="in-email" class="form-input" placeholder="siz@email.com" required autocomplete="email"/>
      </div>
      <div class="form-group">
        <label class="form-label">Parol</label>
        <div class="pwd-wrap">
          <input type="password" id="in-pwd" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required/>
          <button type="button" class="pwd-eye" onclick="togglePwd('in-pwd',this)">üëÅÔ∏è</button>
        </div>
      </div>
      <div style="text-align:right;margin-bottom:1.1rem">
        <a href="#" id="forgot-link" style="font-size:0.8rem;color:var(--accent)">Parolni unutdim?</a>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:0.85rem" data-lbl="Kirish ‚Üí">Kirish ‚Üí</button>
    </form>

    <!-- REGISTER -->
    <form id="form-reg" style="display:none">
      <div class="form-group">
        <label class="form-label">To'liq ism</label>
        <input type="text" id="up-name" class="form-input" placeholder="Ism Familiya" required/>
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="up-email" class="form-input" placeholder="siz@email.com" required autocomplete="email"/>
      </div>
      <div class="form-group">
        <label class="form-label">Parol</label>
        <div class="pwd-wrap">
          <input type="password" id="up-pwd" class="form-input" placeholder="Kamida 6 ta belgi" required/>
          <button type="button" class="pwd-eye" onclick="togglePwd('up-pwd',this)">üëÅÔ∏è</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Parolni tasdiqlang</label>
        <div class="pwd-wrap">
          <input type="password" id="up-confirm" class="form-input" placeholder="Takrorlang" required/>
          <button type="button" class="pwd-eye" onclick="togglePwd('up-confirm',this)">üëÅÔ∏è</button>
        </div>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:0.85rem" data-lbl="Ro'yxatdan o'tish ‚Üí">Ro'yxatdan o'tish ‚Üí</button>
      <p style="font-size:0.74rem;color:var(--text-3);text-align:center;margin-top:0.85rem">Ro'yxatdan o'tish orqali <a href="#">Shartlarga</a> rozilik bildirasiz</p>
    </form>

    <div class="auth-divider">yoki</div>

    <button id="google-btn" class="btn btn-secondary google-btn">
      <div class="g-icon">G</div> Google bilan davom etish
    </button>

    <p style="text-align:center;margin-top:1.25rem;font-size:0.82rem;color:var(--text-3)">
      <a onclick="goTo('index.html');return false" href="#">‚Üê Bosh sahifaga qaytish</a>
    </p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/theme.js"></script>
<script>
function togglePwd(id, btn) {
  const inp = document.getElementById(id);
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
}
function showAlert(msg, type='error') {
  document.getElementById('auth-alert').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}
function clearAlert() { document.getElementById('auth-alert').innerHTML = ''; }
function setBusy(btn, busy) {
  btn.disabled = busy;
  btn.textContent = busy ? '‚è≥ Yuklanmoqda...' : (btn.dataset.lbl || btn.textContent);
}

// Tab switching
const tIn = document.getElementById('tab-in');
const tUp = document.getElementById('tab-up');
const fIn = document.getElementById('form-login');
const fUp = document.getElementById('form-reg');
tIn.addEventListener('click', () => {
  tIn.classList.add('active'); tUp.classList.remove('active');
  fIn.style.display='block'; fUp.style.display='none';
  document.getElementById('auth-h').textContent = 'Xush kelibsiz!';
  document.getElementById('auth-sub').textContent = 'Hisobingizga kiring';
  clearAlert();
});
tUp.addEventListener('click', () => {
  tUp.classList.add('active'); tIn.classList.remove('active');
  fUp.style.display='block'; fIn.style.display='none';
  document.getElementById('auth-h').textContent = 'Hisob yaratish';
  document.getElementById('auth-sub').textContent = 'Bepul ro\'yxatdan o\'ting';
  clearAlert();
});

// Login
fIn.addEventListener('submit', async e => {
  e.preventDefault(); clearAlert();
  const btn = fIn.querySelector('[type="submit"]');
  setBusy(btn, true);
  try {
    await auth.signInWithEmailAndPassword(
      document.getElementById('in-email').value.trim(),
      document.getElementById('in-pwd').value
    );
    window.goTo('dashboard.html');
  } catch(err) {
    const msgs = { 'auth/user-not-found':"Email topilmadi", 'auth/wrong-password':"Parol noto'g'ri", 'auth/invalid-email':"Email noto'g'ri", 'auth/too-many-requests':"Ko'p urinish. Keyinroq sinang" };
    showAlert(msgs[err.code] || err.message);
    setBusy(btn, false);
  }
});

// Register
fUp.addEventListener('submit', async e => {
  e.preventDefault(); clearAlert();
  const btn = fUp.querySelector('[type="submit"]');
  const name = document.getElementById('up-name').value.trim();
  const email = document.getElementById('up-email').value.trim();
  const pwd = document.getElementById('up-pwd').value;
  const conf = document.getElementById('up-confirm').value;
  if (pwd !== conf) { showAlert('Parollar mos kelmadi'); return; }
  if (pwd.length < 6) { showAlert('Parol kamida 6 ta belgi'); return; }
  setBusy(btn, true);
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pwd);
    await cred.user.updateProfile({ displayName: name });
    await DB.createUser(cred.user.uid, { name, email });
    window.goTo('dashboard.html');
  } catch(err) {
    const msgs = { 'auth/email-already-in-use':"Bu email allaqachon ro'yxatdan o'tgan", 'auth/weak-password':"Parol zaif" };
    showAlert(msgs[err.code] || err.message);
    setBusy(btn, false);
  }
});

// Google
document.getElementById('google-btn').addEventListener('click', async () => {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const cred = await auth.signInWithPopup(provider);
    const user = cred.user;
    const exists = await DB.getUser(user.uid);
    if (!exists) await DB.createUser(user.uid, { name: user.displayName||'User', email: user.email });
    window.goTo('dashboard.html');
  } catch(err) { showAlert(err.message); }
});

// Forgot
document.getElementById('forgot-link').addEventListener('click', async e => {
  e.preventDefault();
  const email = document.getElementById('in-email').value.trim();
  if (!email) { showAlert('Avval email kiriting', 'warn'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    showAlert('‚úÖ Parolni tiklash havolasi yuborildi', 'success');
  } catch(err) { showAlert(err.message); }
});

// If already logged in
AuthHelpers.getCurrentUser().then(u => { if (u) goTo('dashboard.html'); });

// Handle hash
if (location.hash === '#register') tUp.click();
</script>
</body>
</html>
